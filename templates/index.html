<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE ORACLE - Premium NBA Edge Finder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>THE ORACLE</h1>
            <p class="subtitle">Sharp angles. No fluff. Pure edge. | Showing 70%+ probability props only</p>
            <div class="stat-selector-container">
                <label for="statTypeSelect" class="stat-selector-label">üìä Stat Category:</label>
                <select id="statTypeSelect" onchange="changeStatType()" class="stat-selector">
                    <optgroup label="Individual Stats">
                        {% for key, stat in individual_stats.items() %}
                        <option value="{{ key }}" {% if current_stat_type == key %}selected{% endif %}>{{ stat.name }}</option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Combination Stats">
                        {% for key, stat in combination_stats.items() %}
                        <option value="{{ key }}" {% if current_stat_type == key %}selected{% endif %}>{{ stat.name }} ({{ stat.abbreviation }})</option>
                        {% endfor %}
                    </optgroup>
                </select>
                <span class="stat-description" id="statDescription">{% if stat_categories and current_stat_type in stat_categories %}{{ stat_categories[current_stat_type].get('description', '') }}{% endif %}</span>
            </div>
            <p class="player-count">
                Loaded: <span id="totalPlayers" style="color: {% if projections|length > 0 %}#27ae60{% else %}#e74c3c{% endif %}; font-weight: bold;">{{ projections|length }}</span> relevant players | 
                Filtered to: <span id="filteredCount">{{ edges|length }}</span> props (70%+)
                <br><small style="color: #95a5a6; font-size: 0.85em;">Auto-loading players with hot streaks, trends, and role players in background...</small>
            </p>
        </header>

        {% if error %}
        <div class="error-message">
            <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        <div class="controls">
            <button onclick="refreshData()" class="refresh-btn" id="refreshBtn">üîÑ Refresh Edges</button>
            <label class="auto-refresh-toggle">
                <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                <span>Auto-refresh (60s)</span>
            </label>
            <button onclick="loadAllPlayers()" class="load-all-btn" id="loadAllBtn" title="Load ALL active NBA players (500+ players, takes 10-15 min)">üì• Load All Players</button>
            <button onclick="showLineManagement()" class="line-mgmt-btn" id="lineMgmtBtn">üìä Line Management</button>
            <button onclick="showParlayCalculator()" class="parlay-btn" id="parlayBtn">üé≤ Parlay Calculator</button>
            <label class="filter-toggle">
                <input type="checkbox" id="showAllToggle" onchange="toggleShowAll()">
                <span>Show All Edges (not just 70%+)</span>
            </label>
            <button onclick="showTacticalFilters()" class="filter-btn" id="filterBtn">üîç Tactical Filters</button>
        </div>

        <!-- Tactical Filters Panel -->
        <div id="tacticalFiltersPanel" class="tactical-filters-panel" style="display: none;">
            <div class="filters-header">
                <h3>üîç Tactical Filters & Sorting</h3>
                <button onclick="hideTacticalFilters()" class="close-btn">‚úï</button>
            </div>
            
            <div class="filters-content">
                <div class="filters-section">
                    <h4>Sort By</h4>
                    <select id="sortSelect" onchange="applyFilters()" class="filter-select">
                        <option value="ev">Expected Value (EV)</option>
                        <option value="market_edge">Market Edge %</option>
                        <option value="probability">Probability</option>
                        <option value="grade">Matchup Grade</option>
                        <option value="edge">Edge Size</option>
                        <option value="kelly">Kelly Criterion</option>
                    </select>
                </div>
                
                <div class="filters-section">
                    <h4>Filters</h4>
                    <div class="filter-group">
                        <label>Min Probability: <span id="probValue">70</span>%</label>
                        <input type="range" id="minProbFilter" min="50" max="95" value="70" oninput="document.getElementById('probValue').textContent = this.value; applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Min EV: $<span id="evValue">0</span></label>
                        <input type="range" id="minEvFilter" min="0" max="50" value="0" oninput="document.getElementById('evValue').textContent = this.value; applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Min Market Edge: <span id="edgeValue">0</span>%</label>
                        <input type="range" id="minEdgeFilter" min="0" max="20" value="0" oninput="document.getElementById('edgeValue').textContent = this.value; applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Min Grade:</label>
                        <select id="minGradeFilter" onchange="applyFilters()" class="filter-select">
                            <option value="">Any</option>
                            <option value="A+">A+</option>
                            <option value="A">A</option>
                            <option value="B+">B+</option>
                            <option value="B" selected>B</option>
                            <option value="C+">C+</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="positiveEvOnly" onchange="applyFilters()">
                            Positive EV Only
                        </label>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="excludeInjuries" onchange="applyFilters()">
                            Exclude Injury Risks
                        </label>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="excludeRotation" onchange="applyFilters()">
                            Exclude Rotation Changes
                        </label>
                    </div>
                </div>
                
                <div class="filters-actions">
                    <button onclick="resetFilters()" class="reset-btn">Reset Filters</button>
                    <button onclick="hideTacticalFilters()" class="apply-btn">Apply</button>
                </div>
            </div>
        </div>


        <div class="status-bar">
            <span id="lastUpdate">Last updated: {{ "Now" if edges else "Never" }}</span>
            <span id="loadingIndicator" class="loading" style="display: none;">‚è≥ Updating...</span>
            <span id="dailyUpdateStatus" class="daily-status"></span>
        </div>

        <!-- Line Management Panel -->
        <div id="lineManagementPanel" class="line-management-panel" style="display: none;">
            <div class="panel-header">
                <h3>üìä Line Management</h3>
                <button onclick="hideLineManagement()" class="close-btn">‚úï</button>
            </div>
            
            <div class="panel-tabs">
                <button class="tab-btn active" onclick="showTab('line-changes')">Line Changes</button>
                <button class="tab-btn" onclick="showTab('chase-list')">Chase List</button>
                <button class="tab-btn" onclick="showTab('alt-lines')">Alt Lines</button>
                <button class="tab-btn" onclick="showTab('edit-lines')">Edit Lines</button>
            </div>

            <!-- Line Changes Tab -->
            <div id="tab-line-changes" class="tab-content active">
                <h4>Line Changes (Last 24h)</h4>
                <div id="lineChangesContainer"></div>
                <button onclick="loadLineChanges()" class="refresh-btn">üîÑ Refresh Changes</button>
            </div>

            <!-- Chase List Tab -->
            <div id="tab-chase-list" class="tab-content">
                <h4>Props to Chase</h4>
                <div id="chaseListContainer"></div>
                <button onclick="loadChaseList()" class="refresh-btn">üîÑ Refresh</button>
            </div>

            <!-- Alt Lines Tab -->
            <div id="tab-alt-lines" class="tab-content">
                <h4>Alternative Lines</h4>
                <div id="altLinesContainer"></div>
                <button onclick="loadAltLines()" class="refresh-btn">üîÑ Refresh</button>
            </div>

            <!-- Edit Lines Tab -->
            <div id="tab-edit-lines" class="tab-content">
                <h4>Edit Lines (Even After Send-Off)</h4>
                <div class="edit-lines-form">
                    <select id="editPlayerSelect" class="player-select">
                        <option value="">Select Player...</option>
                        {% for player in projections.keys() %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                    </select>
                    <input type="number" id="oldLineInput" step="0.5" placeholder="Old Line" class="line-input">
                    <input type="number" id="newLineInput" step="0.5" placeholder="New Line" class="line-input">
                    <button onclick="updateLine()" class="update-btn">Update Line</button>
                </div>
                <div id="editResult"></div>
            </div>
        </div>

        <div id="errorContainer"></div>

        <div id="edgesContainer">
            {% if edges %}
                <div class="edges-section">
                    <h2>70%+ PROBABILITY PROPS (<span id="edgeCount">{{ edges|length }}</span>)</h2>
                    <p class="section-subtitle">Only showing props with 70%+ hit probability from all active NBA players</p>
                    <div class="edges-grid" id="edgesGrid">
                        {% for edge in edges %}
                        <div class="oracle-card {{ edge.recommendation|lower }}">
                            <div class="oracle-header-row">
                                <div class="oracle-player">{{ edge.player }}</div>
                                {% if edge.ev %}
                                <div class="ev-badge {% if edge.ev.is_positive_ev %}positive-ev{% else %}negative-ev{% endif %}">
                                    EV: ${{ edge.ev.ev|round(2) }}
                                </div>
                                {% endif %}
                                {% if edge.matchup_grade %}
                                <div class="grade-badge grade-{{ edge.matchup_grade.grade|lower|replace('+', 'plus')|replace('-', 'minus') }}">
                                    {{ edge.matchup_grade.grade }}
                                </div>
                                {% endif %}
                            </div>
                            {% if edge.oracle %}
                            <div class="oracle-content">
                                <div class="oracle-line">
                                    <strong>The Line:</strong> {{ edge.oracle.verdict }}
                                </div>
                                <div class="oracle-sharp">
                                    <strong>The Sharp Angle:</strong> {{ edge.oracle.sharp_angle }}
                                </div>
                                <div class="oracle-key">
                                    <strong>Key Data Point:</strong> {{ edge.oracle.key_data }}
                                </div>
                                <div class="oracle-verdict">
                                    <strong>The Verdict:</strong> {{ edge.oracle.verdict }}
                                </div>
                                <div class="oracle-confidence">
                                    <strong>Confidence:</strong> 
                                    <span class="confidence-badge confidence-{{ edge.oracle.confidence|int }}">
                                        {{ edge.oracle.confidence }} Units
                                    </span>
                                </div>
                                <div class="oracle-risk">
                                    <strong>Risk Factor:</strong> {{ edge.oracle.risk_factor }}
                                </div>
                                {% if edge.advanced_metrics %}
                                <div class="advanced-metrics">
                                    <div class="metrics-row">
                                        <span>FG%:</span> <span>{{ edge.advanced_metrics.fg_pct }}%</span>
                                        <span>Pts/36:</span> <span>{{ edge.advanced_metrics.points_per_36 }}</span>
                                        <span>CV:</span> <span>{{ edge.advanced_metrics.consistency }}%</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="edge-details">
                                <div class="stat-row">
                                    <span class="label">Line:</span>
                                    <span class="value">{{ edge.line }}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="label">L5 Avg:</span>
                                    <span class="value">{{ edge.average }}</span>
                                </div>
                                <div class="recommendation">
                                    <strong>{{ edge.recommendation }}</strong>
                                </div>
                            </div>
                            {% endif %}
                            {% if edge.streak and edge.streak.active %}
                            <div class="streak-badge streak-{{ edge.streak.streak_type|lower }}">
                                üî• {{ edge.streak.streak_count }}-game {{ edge.streak.streak_type }} streak
                            </div>
                            {% endif %}
                                {% if edge.factors %}
                                <div class="performance-factors">
                                    <div class="factors-header" onclick="toggleFactors(this)">
                                        <span>üìä Performance Factors</span>
                                        <span class="toggle-icon">‚ñº</span>
                                    </div>
                                    <div class="factors-content" style="display: none;">
                                        {% if edge.factors.injury_risk %}
                                        <div class="factor-badge factor-warning">
                                            ‚ö†Ô∏è Injury Risk ({{ edge.factors.dnp_count }} DNP game{{ 's' if edge.factors.dnp_count != 1 else '' }})
                                        </div>
                                        {% endif %}
                                        {% if edge.factors.rotation_change %}
                                        <div class="factor-badge factor-info">
                                            üîÑ Rotation Change ({{ edge.factors.recent_minutes_avg }} min recent vs {{ edge.factors.older_minutes_avg }} min earlier)
                                        </div>
                                        {% endif %}
                                        <div class="factor-row">
                                            <span class="factor-label">Minutes Trend:</span>
                                            <span class="factor-value trend-{{ edge.factors.minutes_trend }}">
                                                {{ edge.factors.recent_minutes_avg }} min ({{ edge.factors.minutes_trend }})
                                            </span>
                                        </div>
                                        <div class="factor-row">
                                            <span class="factor-label">Performance Trend:</span>
                                            <span class="factor-value trend-{{ edge.factors.performance_trend }}">
                                                {{ edge.factors.performance_trend|title }}
                                            </span>
                                        </div>
                                        {% if edge.factors.shooting_efficiency %}
                                        <div class="factor-row">
                                            <span class="factor-label">FG% (L5):</span>
                                            <span class="factor-value">{{ edge.factors.shooting_efficiency }}%</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <div class="no-edges">
                    <p>No edges found with current threshold.</p>
                    <p class="info">Checked <span id="playerCount">{{ projections|length }}</span> players. Adjust threshold or check projections.</p>
                </div>
            {% endif %}
        </div>

        <!-- Parlay Recommendations Section -->
        <div id="parlaySection" class="parlay-section" style="display: none;">
            <h2>üé≤ PARLAY RECOMMENDATIONS</h2>
            <p class="section-subtitle">Best parlay combinations based on 70%+ probability props</p>
            
            <div class="parlay-tabs">
                <button class="parlay-tab active" onclick="showParlayTab('2-man')">2-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('3-man')">3-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('4-man')">4-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('6-man')">6-Man</button>
            </div>
            
            <div id="parlay-2-man" class="parlay-tab-content active">
                <h3>2-Man Parlays</h3>
                <div id="parlay2ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-3-man" class="parlay-tab-content">
                <h3>3-Man Parlays</h3>
                <div id="parlay3ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-4-man" class="parlay-tab-content">
                <h3>4-Man Parlays</h3>
                <div id="parlay4ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-6-man" class="parlay-tab-content">
                <h3>6-Man Parlays</h3>
                <div id="parlay6ManContainer" class="parlay-container"></div>
            </div>
        </div>

        <!-- Parlay Calculator Modal -->
        <div id="parlayCalculatorModal" class="parlay-modal" style="display: none;">
            <div class="parlay-modal-content">
                <div class="parlay-modal-header">
                    <h2>üé≤ Parlay Calculator</h2>
                    <button onclick="hideParlayCalculator()" class="close-btn">‚úï</button>
                </div>
                <div class="parlay-calculator-body">
                    <div class="calculator-inputs">
                        <h3>Add Bets</h3>
                        <div id="betsList"></div>
                        <button onclick="addBetRow()" class="add-bet-btn">+ Add Bet</button>
                        <div class="calculator-results">
                            <h3>Parlay Results</h3>
                            <div id="calculatorResults"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="highProbContainer">
            {% if high_prob_props %}
                <div class="high-prob-section">
                    <h2>üéØ HIGH PROBABILITY PROPS (70%+) - <span id="highProbCount">{{ high_prob_props|length }}</span></h2>
                    <p class="section-subtitle">PrizePicks/Underdog Format | Sorted by Probability</p>
                    <div class="high-prob-grid" id="highProbGrid">
                        {% for prop in high_prob_props %}
                        <div class="high-prob-card">
                            <div class="prob-header">
                                <div class="prob-badge">{{ prop.probability }}%</div>
                                <div class="prizepicks-display">{{ prop.prizepicks.display }}</div>
                            </div>
                            <div class="prob-details">
                                <div class="prob-reasoning">
                                    <strong>Reasoning:</strong> {{ prop.reasoning }}
                                </div>
                                <div class="prob-stats">
                                    <div class="stat-item">
                                        <span>L5 Average:</span>
                                        <span>{{ prop.edge.average }}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Line:</span>
                                        <span>{{ prop.edge.line }}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Edge:</span>
                                        <span class="edge-value">{{ prop.edge.difference }}pts</span>
                                    </div>
                                </div>
                                {% if prop.edge.streak and prop.edge.streak.active %}
                                <div class="streak-indicator">
                                    üî• {{ prop.edge.streak.streak_count }}-game {{ prop.edge.streak.streak_type }} streak
                                </div>
                                {% endif %}
                                {% if prop.beneficiary %}
                                <div class="matchup-indicator">
                                    ‚ö° vs {{ prop.beneficiary.opponent }}: {{ prop.beneficiary.mismatch }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Parlay Recommendations Section -->
        <div id="parlaySection" class="parlay-section" style="display: none;">
            <h2>üé≤ PARLAY RECOMMENDATIONS</h2>
            <p class="section-subtitle">Best parlay combinations based on 70%+ probability props</p>
            
            <div class="parlay-tabs">
                <button class="parlay-tab active" onclick="showParlayTab('2-man')">2-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('3-man')">3-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('4-man')">4-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('6-man')">6-Man</button>
            </div>
            
            <div id="parlay-2-man" class="parlay-tab-content active">
                <h3>2-Man Parlays</h3>
                <div id="parlay2ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-3-man" class="parlay-tab-content">
                <h3>3-Man Parlays</h3>
                <div id="parlay3ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-4-man" class="parlay-tab-content">
                <h3>4-Man Parlays</h3>
                <div id="parlay4ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-6-man" class="parlay-tab-content">
                <h3>6-Man Parlays</h3>
                <div id="parlay6ManContainer" class="parlay-container"></div>
            </div>
        </div>

        <!-- Parlay Calculator Modal -->
        <div id="parlayCalculatorModal" class="parlay-modal" style="display: none;">
            <div class="parlay-modal-content">
                <div class="parlay-modal-header">
                    <h2>üé≤ Parlay Calculator</h2>
                    <button onclick="hideParlayCalculator()" class="close-btn">‚úï</button>
                </div>
                <div class="parlay-calculator-body">
                    <div class="calculator-inputs">
                        <h3>Add Bets</h3>
                        <div id="betsList"></div>
                        <button onclick="addBetRow()" class="add-bet-btn">+ Add Bet</button>
                        <div class="calculator-results">
                            <h3>Parlay Results</h3>
                            <div id="calculatorResults"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="streaksContainer">
            {% if streaks %}
                <div class="streaks-section">
                    <h2>üî• Active Streaks (<span id="streakCount">{{ streaks|length }}</span>)</h2>
                    <p class="section-subtitle">Players consistently hitting OVER/UNDER for 2+ games</p>
                    <div class="streaks-grid" id="streaksGrid">
                        {% for streak in streaks %}
                        <div class="streak-card streak-{{ streak.streak_type|lower }}">
                            <div class="player-name">{{ streak.player }}</div>
                            <div class="streak-details">
                                <div class="stat-row">
                                    <span class="label">Line:</span>
                                    <span class="value">{{ streak.line }}</span>
                                </div>
                                {% if streak.average %}
                                <div class="stat-row">
                                    <span class="label">L5 Average:</span>
                                    <span class="value">{{ streak.average }}</span>
                                </div>
                                {% endif %}
                                <div class="streak-info">
                                    <div class="streak-badge-large streak-{{ streak.streak_type|lower }}">
                                        üî• {{ streak.streak_count }}-game {{ streak.streak_type }} streak
                                    </div>
                                </div>
                                {% if streak.factors %}
                                <div class="performance-factors">
                                    <div class="factors-header" onclick="toggleFactors(this)">
                                        <span>üìä Performance Factors</span>
                                        <span class="toggle-icon">‚ñº</span>
                                    </div>
                                    <div class="factors-content" style="display: none;">
                                        {% if streak.factors.injury_risk %}
                                        <div class="factor-badge factor-warning">
                                            ‚ö†Ô∏è Injury Risk ({{ streak.factors.dnp_count }} DNP game{{ 's' if streak.factors.dnp_count != 1 else '' }})
                                        </div>
                                        {% endif %}
                                        {% if streak.factors.rotation_change %}
                                        <div class="factor-badge factor-info">
                                            üîÑ Rotation Change ({{ streak.factors.recent_minutes_avg }} min recent vs {{ streak.factors.older_minutes_avg }} min earlier)
                                        </div>
                                        {% endif %}
                                        <div class="factor-row">
                                            <span class="factor-label">Minutes Trend:</span>
                                            <span class="factor-value trend-{{ streak.factors.minutes_trend }}">
                                                {{ streak.factors.recent_minutes_avg }} min ({{ streak.factors.minutes_trend }})
                                            </span>
                                        </div>
                                        <div class="factor-row">
                                            <span class="factor-label">Performance Trend:</span>
                                            <span class="factor-value trend-{{ streak.factors.performance_trend }}">
                                                {{ streak.factors.performance_trend|title }}
                                            </span>
                                        </div>
                                        {% if streak.factors.shooting_efficiency %}
                                        <div class="factor-row">
                                            <span class="factor-label">FG% (L5):</span>
                                            <span class="factor-value">{{ streak.factors.shooting_efficiency }}%</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="projections-section">
            <div class="projections-header">
                <h3>Current Projections (<span id="projectionCount">{{ projections|length }}</span> players)</h3>
                <input type="text" id="playerSearch" placeholder="üîç Search players..." class="player-search" onkeyup="filterPlayers()">
            </div>
            <div class="table-container">
                <table class="projections-table" id="projectionsTable">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Line</th>
                        </tr>
                    </thead>
                    <tbody id="projectionsTableBody">
                        {% for player, line in projections.items() %}
                        <tr>
                            <td>{{ player }}</td>
                            <td>{{ line }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="glitched-props-section">
            <div class="glitched-props-header">
                <h3>üî¥ Glitched Props (Auto-Scanned 24/7)</h3>
                <div class="glitched-props-actions">
                    <button onclick="triggerGlitchedScan()" class="btn-scan-glitch">üîç Run Scan Now</button>
                    <button onclick="showAddGlitchedPropForm()" class="btn-add-glitch">+ Add Manual</button>
                </div>
            </div>
            <div id="glitchedScanStatus" class="scan-status-bar">
                <span id="scanStatusText">Loading scan status...</span>
            </div>
            <div class="table-container">
                <table class="glitched-props-table" id="glitchedPropsTable">
                    <thead>
                        <tr>
                            <th>Prop</th>
                            <th>Reasoning</th>
                            <th>Rating</th>
                            <th>Platform</th>
                            <th>Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="glitchedPropsTableBody">
                        {% for prop in glitched_props %}
                        <tr data-id="{{ prop.id }}">
                            <td>{{ prop.prop }}</td>
                            <td>{{ prop.reasoning }}</td>
                            <td>
                                <span class="rating-badge rating-{{ prop.rating }}">
                                    {{ prop.rating }}/10
                                </span>
                            </td>
                            <td>{{ prop.platform }}</td>
                            <td>{{ prop.updated_at }}</td>
                            <td>
                                <button onclick="editGlitchedProp({{ prop.id }})" class="btn-edit">‚úèÔ∏è</button>
                                <button onclick="deleteGlitchedProp({{ prop.id }})" class="btn-delete">üóëÔ∏è</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add/Edit Glitched Prop Modal -->
        <div id="glitchedPropModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeGlitchedPropModal()">&times;</span>
                <h3 id="modalTitle">Add Glitched Prop</h3>
                <form id="glitchedPropForm" onsubmit="saveGlitchedProp(event)">
                    <input type="hidden" id="glitchedPropId" value="">
                    <div class="form-group">
                        <label for="glitchedPropInput">Prop:</label>
                        <input type="text" id="glitchedPropInput" placeholder="e.g., LeBron James O 24.5 PTS" required>
                    </div>
                    <div class="form-group">
                        <label for="glitchedReasoningInput">Reasoning:</label>
                        <textarea id="glitchedReasoningInput" placeholder="Why is this glitched? (e.g., Line is 3 points off market average)" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="glitchedRatingInput">Rating (1-10):</label>
                        <input type="number" id="glitchedRatingInput" min="1" max="10" value="5" required>
                        <small>10 = most glitched/valuable</small>
                    </div>
                    <div class="form-group">
                        <label for="glitchedPlatformInput">Platform:</label>
                        <input type="text" id="glitchedPlatformInput" placeholder="e.g., PrizePicks, Underdog, DraftKings" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-save">Save</button>
                        <button type="button" onclick="closeGlitchedPropModal()" class="btn-cancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <footer>
            <p>THE ORACLE | NBA API | Real-time edge detection</p>
        </footer>
    </div>

    <script>
        let autoRefreshInterval = null;
        const REFRESH_INTERVAL = 60000; // 60 seconds

        function updatePage(data) {
            // Update timestamp
            document.getElementById('lastUpdate').textContent = `Last updated: ${data.timestamp}`;
            
            // Clear error
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = '';
            
            if (data.error) {
                errorContainer.innerHTML = `<div class="error-message"><strong>Error:</strong> ${data.error}</div>`;
                return;
            }

            // Update player count
            const totalPlayersEl = document.getElementById('totalPlayers');
            const filteredCountEl = document.getElementById('filteredCount');
            const playerCount = data.total_players_loaded || 0;
            if (totalPlayersEl) {
                totalPlayersEl.textContent = playerCount;
                // Update color based on count (green if >0, red if 0)
                totalPlayersEl.style.color = playerCount > 0 ? '#27ae60' : '#e74c3c';
            }
            if (filteredCountEl) filteredCountEl.textContent = data.edges?.length || 0;
            
            // Update edges with pagination
            const edges = data.edges || [];
            allEdges = edges; // Store for pagination
            const edgesContainer = document.getElementById('edgesContainer');
            const showing70Plus = data.showing_70_plus_only !== false;
            
            if (edges.length > 0) {
                // Reset to page 1 if we have new data (different length)
                if (allEdges.length !== edges.length) {
                    currentPage = 1;
                }
                
                const totalPages = Math.ceil(edges.length / itemsPerPage);
                currentPage = Math.min(currentPage, totalPages || 1);
                
                const startIdx = (currentPage - 1) * itemsPerPage;
                const endIdx = startIdx + itemsPerPage;
                const pageEdges = edges.slice(startIdx, endIdx);
                
                edgesContainer.innerHTML = `
                    <div class="edges-section">
                        <div class="section-header">
                            <h2>${showing70Plus ? '70%+ PROBABILITY PROPS' : 'ALL EDGES'} (<span id="edgeCount">${edges.length}</span>)</h2>
                            ${totalPages > 1 ? `
                            <div class="pagination-controls">
                                <button onclick="previousPage()" id="prevBtn" class="page-btn" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Previous</button>
                                <span id="pageInfo">Page ${currentPage} of ${totalPages} (${startIdx + 1}-${Math.min(endIdx, edges.length)} of ${edges.length})</span>
                                <button onclick="nextPage()" id="nextBtn" class="page-btn" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>
                            </div>
                            ` : ''}
                        </div>
                        ${showing70Plus ? '<p class="section-subtitle">Only showing props with 70%+ hit probability from all active NBA players</p>' : '<p class="section-subtitle">Showing all edges (including below 70%)</p>'}
                        <div class="edges-grid" id="edgesGrid">
                            ${pageEdges.map(edge => {
                                const streakBadge = edge.streak && edge.streak.active 
                                    ? `<div class="streak-badge streak-${edge.streak.streak_type.toLowerCase()}">üî• ${edge.streak.streak_count}-game ${edge.streak.streak_type} streak</div>`
                                    : '';
                                
                                if (edge.oracle) {
                                    const confidenceClass = Math.floor(edge.oracle.confidence);
                                    const advancedMetrics = edge.advanced_metrics 
                                        ? `<div class="advanced-metrics"><div class="metrics-row"><span>FG%:</span> <span>${edge.advanced_metrics.fg_pct}%</span> <span>Pts/36:</span> <span>${edge.advanced_metrics.points_per_36}</span> <span>CV:</span> <span>${edge.advanced_metrics.consistency}%</span></div></div>`
                                        : '';
                                    
                                    const playerName = edge.player || edge.player_name || 'Unknown Player';
                                    const recommendation = edge.recommendation || 'OVER';
                                    return `
                                    <div class="oracle-card ${recommendation.toLowerCase()}">
                                        <div class="oracle-header-row">
                                            <div class="oracle-player">${playerName}</div>
                                            ${edge.ev ? `
                                            <div class="ev-badge ${edge.ev.is_positive_ev ? 'positive-ev' : 'negative-ev'}">
                                                EV: $${edge.ev.ev.toFixed(2)}
                                            </div>
                                            ` : ''}
                                            ${edge.matchup_grade ? `
                                            <div class="grade-badge grade-${edge.matchup_grade.grade.toLowerCase().replace('+', 'plus').replace('-', 'minus')}">
                                                ${edge.matchup_grade.grade}
                                            </div>
                                            ` : ''}
                                        </div>
                                        <div class="oracle-content">
                                            <div class="oracle-line"><strong>The Line:</strong> ${edge.oracle.verdict}</div>
                                            <div class="oracle-sharp"><strong>The Sharp Angle:</strong> ${edge.oracle.sharp_angle}</div>
                                            <div class="oracle-key"><strong>Key Data Point:</strong> ${edge.oracle.key_data}</div>
                                            <div class="oracle-verdict"><strong>The Verdict:</strong> ${edge.oracle.verdict}</div>
                                            <div class="oracle-confidence"><strong>Confidence:</strong> <span class="confidence-badge confidence-${confidenceClass}">${edge.oracle.confidence} Units</span></div>
                                            <div class="oracle-risk"><strong>Risk Factor:</strong> ${edge.oracle.risk_factor}</div>
                                        ${advancedMetrics}
                                    </div>
                                    ${edge.beneficiary ? `
                                    <div class="phase2-analysis">
                                        <div class="phase2-header" onclick="togglePhase2(this)">
                                            <span>‚ö° PHASE 2: STATISTICAL BENEFICIARY</span>
                                            <span class="toggle-icon">‚ñº</span>
                                        </div>
                                        <div class="phase2-content" style="display: none;">
                                            <div class="phase2-item"><strong>1. The Player:</strong> ${edge.beneficiary.player} (${edge.beneficiary.position})</div>
                                            <div class="phase2-item"><strong>2. The Mismatch:</strong> ${edge.beneficiary.mismatch}</div>
                                            <div class="phase2-item"><strong>3. The Consensus Expectation:</strong> ${edge.beneficiary.consensus_expectation} ${edge.stat_type}</div>
                                            <div class="phase2-item"><strong>4. The Projection:</strong> ${edge.beneficiary.projection_direction} (${edge.beneficiary.projection} ${edge.stat_type})</div>
                                            <div class="phase2-item"><strong>5. The Confidence Logic:</strong> ${edge.beneficiary.confidence_logic}</div>
                                            ${edge.beneficiary.matchup_data ? `
                                            <div class="phase2-metrics">
                                                <div class="metric-item"><span>Avg vs Opponent:</span> <span>${edge.beneficiary.matchup_data.avg_vs_opponent}</span></div>
                                                <div class="metric-item"><span>Overall Avg:</span> <span>${edge.beneficiary.matchup_data.overall_avg}</span></div>
                                                ${edge.beneficiary.matchup_data.advantage ? `<div class="metric-item"><span>Advantage:</span> <span class="advantage-positive">+${edge.beneficiary.matchup_data.advantage}</span></div>` : ''}
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${streakBadge}
                                    </div>
                                    `;
                                } else {
                                    const playerName = edge.player || edge.player_name || 'Unknown Player';
                                    const recommendation = edge.recommendation || 'OVER';
                                    return `
                                    <div class="edge-card ${recommendation.toLowerCase()}">
                                        <div class="player-name">${playerName}</div>
                                        <div class="edge-details">
                                            <div class="stat-row"><span class="label">Line:</span><span class="value">${edge.line || 'N/A'}</span></div>
                                            <div class="stat-row"><span class="label">L5 Avg:</span><span class="value">${edge.average || 'N/A'}</span></div>
                                            <div class="recommendation"><strong>${recommendation}</strong></div>
                                        </div>
                                        ${streakBadge}
                                    </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                const playerCount = Object.keys(data.projections).length;
                edgesContainer.innerHTML = `
                    <div class="no-edges">
                        <p>No edges found with current threshold.</p>
                        <p class="info">Checked <span id="playerCount">${playerCount}</span> players. Adjust threshold or check projections.</p>
                    </div>
                `;
            }

            // Update streaks (sort by streak count, longest first)
            const streaksContainer = document.getElementById('streaksContainer');
            let streaks = data.streaks || [];
            streaks.sort((a, b) => (b.streak_count || 0) - (a.streak_count || 0));
            
            if (streaks.length > 0) {
                streaksContainer.innerHTML = `
                    <div class="streaks-section">
                        <h2>üî• Active Streaks (<span id="streakCount">${streaks.length}</span>)</h2>
                        <p class="section-subtitle">Players consistently hitting OVER/UNDER for 2+ games</p>
                        <div class="streaks-grid" id="streaksGrid">
                            ${streaks.map(streak => `
                                <div class="streak-card streak-${streak.streak_type.toLowerCase()}">
                                    <div class="player-name">${streak.player}</div>
                                    <div class="streak-details">
                                        <div class="stat-row">
                                            <span class="label">Line:</span>
                                            <span class="value">${streak.line}</span>
                                        </div>
                                        ${streak.average ? `
                                        <div class="stat-row">
                                            <span class="label">L5 Average:</span>
                                            <span class="value">${streak.average}</span>
                                        </div>
                                        ` : ''}
                                        <div class="streak-info">
                                            <div class="streak-badge-large streak-${streak.streak_type.toLowerCase()}">
                                                üî• ${streak.streak_count}-game ${streak.streak_type} streak
                                            </div>
                                        </div>
                                        ${streak.factors ? `
                                        <div class="performance-factors">
                                            <div class="factors-header" onclick="toggleFactors(this)">
                                                <span>üìä Performance Factors</span>
                                                <span class="toggle-icon">‚ñº</span>
                                            </div>
                                            <div class="factors-content" style="display: none;">
                                                ${edge.factors.injury_risk ? `
                                                <div class="factor-badge factor-warning">
                                                    ‚ö†Ô∏è Injury Risk (${edge.factors.dnp_count} DNP game${edge.factors.dnp_count !== 1 ? 's' : ''})
                                                </div>
                                                ` : ''}
                                                ${edge.factors.rotation_change ? `
                                                <div class="factor-badge factor-info">
                                                    üîÑ Rotation Change (${edge.factors.recent_minutes_avg} min recent vs ${edge.factors.older_minutes_avg} min earlier)
                                                </div>
                                                ` : ''}
                                                <div class="factor-row">
                                                    <span class="factor-label">Minutes Trend:</span>
                                                    <span class="factor-value trend-${edge.factors.minutes_trend}">
                                                        ${edge.factors.recent_minutes_avg} min (${edge.factors.minutes_trend})
                                                    </span>
                                                </div>
                                                <div class="factor-row">
                                                    <span class="factor-label">Performance Trend:</span>
                                                    <span class="factor-value trend-${edge.factors.performance_trend}">
                                                        ${edge.factors.performance_trend.charAt(0).toUpperCase() + edge.factors.performance_trend.slice(1)}
                                                    </span>
                                                </div>
                                                ${edge.factors.shooting_efficiency ? `
                                                <div class="factor-row">
                                                    <span class="factor-label">FG% (L5):</span>
                                                    <span class="factor-value">${edge.factors.shooting_efficiency}%</span>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                const playerCount = Object.keys(data.projections).length;
                edgesContainer.innerHTML = `
                    <div class="no-edges">
                        <p>No edges found with current threshold.</p>
                        <p class="info">Checked <span id="playerCount">${playerCount}</span> players. Adjust threshold or check projections.</p>
                    </div>
                `;
            }

            // Update streaks (sort by streak count, longest first)
            const streaksContainer = document.getElementById('streaksContainer');
            let streaks = data.streaks || [];
            streaks.sort((a, b) => (b.streak_count || 0) - (a.streak_count || 0));
            
            if (streaks.length > 0) {
                streaksContainer.innerHTML = `
                    <div class="streaks-section">
                        <h2>üî• Active Streaks (<span id="streakCount">${streaks.length}</span>)</h2>
                        <p class="section-subtitle">Players consistently hitting OVER/UNDER for 2+ games</p>
                        <div class="streaks-grid" id="streaksGrid">
                            ${streaks.map(streak => `
                                <div class="streak-card streak-${streak.streak_type.toLowerCase()}">
                                    <div class="player-name">${streak.player}</div>
                                    <div class="streak-details">
                                        <div class="stat-row">
                                            <span class="label">Line:</span>
                                            <span class="value">${streak.line}</span>
                                        </div>
                                        ${streak.average ? `
                                        <div class="stat-row">
                                            <span class="label">L5 Average:</span>
                                            <span class="value">${streak.average}</span>
                                        </div>
                                        ` : ''}
                                        <div class="streak-info">
                                            <div class="streak-badge-large streak-${streak.streak_type.toLowerCase()}">
                                                üî• ${streak.streak_count}-game ${streak.streak_type} streak
                                            </div>
                                        </div>
                                        ${streak.factors ? `
                                        <div class="performance-factors">
                                            <div class="factors-header" onclick="toggleFactors(this)">
                                                <span>üìä Performance Factors</span>
                                                <span class="toggle-icon">‚ñº</span>
                                            </div>
                                            <div class="factors-content" style="display: none;">
                                                ${streak.factors.injury_risk ? `
                                                <div class="factor-badge factor-warning">
                                                    ‚ö†Ô∏è Injury Risk (${streak.factors.dnp_count} DNP game${streak.factors.dnp_count !== 1 ? 's' : ''})
                                                </div>
                                                ` : ''}
                                                ${streak.factors.rotation_change ? `
                                                <div class="factor-badge factor-info">
                                                    üîÑ Rotation Change (${streak.factors.recent_minutes_avg} min recent vs ${streak.factors.older_minutes_avg} min earlier)
                                                </div>
                                                ` : ''}
                                                <div class="factor-row">
                                                    <span class="factor-label">Minutes Trend:</span>
                                                    <span class="factor-value trend-${streak.factors.minutes_trend}">
                                                        ${streak.factors.recent_minutes_avg} min (${streak.factors.minutes_trend})
                                                    </span>
                                                </div>
                                                <div class="factor-row">
                                                    <span class="factor-label">Performance Trend:</span>
                                                    <span class="factor-value trend-${streak.factors.performance_trend}">
                                                        ${streak.factors.performance_trend.charAt(0).toUpperCase() + streak.factors.performance_trend.slice(1)}
                                                    </span>
                                                </div>
                                                ${streak.factors.shooting_efficiency ? `
                                                <div class="factor-row">
                                                    <span class="factor-label">FG% (L5):</span>
                                                    <span class="factor-value">${streak.factors.shooting_efficiency}%</span>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                streaksContainer.innerHTML = '';
            }

            // Update parlay recommendations
            checkParlayRecommendations(data);
            
            // Update high probability props
            const highProbContainer = document.getElementById('highProbContainer');
            const highProbProps = data.high_prob_props || [];
            
            if (highProbProps.length > 0) {
                highProbContainer.innerHTML = `
                    <div class="high-prob-section">
                        <h2>üéØ HIGH PROBABILITY PROPS (70%+) - <span id="highProbCount">${highProbProps.length}</span></h2>
                        <p class="section-subtitle">PrizePicks/Underdog Format | Sorted by Probability</p>
                        <div class="high-prob-grid" id="highProbGrid">
                            ${highProbProps.map(prop => {
                                const streakBadge = prop.edge.streak && prop.edge.streak.active 
                                    ? `<div class="streak-indicator">üî• ${prop.edge.streak.streak_count}-game ${prop.edge.streak.streak_type} streak</div>`
                                    : '';
                                const matchupBadge = prop.beneficiary 
                                    ? `<div class="matchup-indicator">‚ö° vs ${prop.beneficiary.opponent}: ${prop.beneficiary.mismatch}</div>`
                                    : '';
                                
                                return `
                                <div class="high-prob-card">
                                    <div class="prob-header">
                                        <div class="prob-badge">${prop.probability}%</div>
                                        <div class="prizepicks-display">${prop.prizepicks.display}</div>
                                    </div>
                                    <div class="prob-details">
                                        <div class="prob-reasoning">
                                            <strong>Reasoning:</strong> ${prop.reasoning}
                                        </div>
                                        <div class="prob-stats">
                                            <div class="stat-item">
                                                <span>L5 Average:</span>
                                                <span>${prop.edge.average}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span>Line:</span>
                                                <span>${prop.edge.line}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span>Edge:</span>
                                                <span class="edge-value">${prop.edge.difference}pts</span>
                                            </div>
                                        </div>
                                        ${streakBadge}
                                        ${matchupBadge}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                highProbContainer.innerHTML = '';
            }

            // Update projections table
            const projectionsTable = document.getElementById('projectionsTable');
            const tbody = document.getElementById('projectionsTableBody');
            const projectionCount = document.getElementById('projectionCount');
            
            tbody.innerHTML = Object.entries(data.projections).map(([player, line]) => `
                <tr>
                    <td>${player}</td>
                    <td>${line}</td>
                </tr>
            `).join('');
            
            projectionCount.textContent = Object.keys(data.projections).length;

            // Update glitched props
            if (data.glitched_props) {
                updateGlitchedPropsTable(data.glitched_props);
            }
        }

        function filterPlayers() {
            const searchInput = document.getElementById('playerSearch');
            const filter = searchInput.value.toLowerCase();
            const table = document.getElementById('projectionsTable');
            const rows = table.getElementsByTagName('tr');
            
            let visibleCount = 0;
            
            // Start from index 1 to skip header row
            for (let i = 1; i < rows.length; i++) {
                const playerCell = rows[i].getElementsByTagName('td')[0];
                if (playerCell) {
                    const playerName = playerCell.textContent || playerCell.innerText;
                    if (playerName.toLowerCase().indexOf(filter) > -1) {
                        rows[i].style.display = '';
                        visibleCount++;
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }

        let refreshTimeout = null;
        let isRefreshing = false;
        
        function buildFilterParams() {
            const params = new URLSearchParams();
            
            // Stat type
            const statTypeSelect = document.getElementById('statTypeSelect');
            if (statTypeSelect) {
                params.append('stat_type', statTypeSelect.value);
            }
            
            // Show all toggle
            const showAllToggle = document.getElementById('showAllToggle');
            if (showAllToggle && showAllToggle.checked) {
                params.append('show_all', 'true');
            }
            
            // Sort by
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) {
                params.append('sort_by', sortSelect.value);
            }
            
            // Filters
            const minProbFilter = document.getElementById('minProbFilter');
            if (minProbFilter) {
                params.append('min_probability', minProbFilter.value);
            }
            
            const minEvFilter = document.getElementById('minEvFilter');
            if (minEvFilter) {
                params.append('min_ev', minEvFilter.value);
            }
            
            const minEdgeFilter = document.getElementById('minEdgeFilter');
            if (minEdgeFilter) {
                params.append('min_market_edge', minEdgeFilter.value);
            }
            
            const minGradeFilter = document.getElementById('minGradeFilter');
            if (minGradeFilter && minGradeFilter.value) {
                params.append('min_grade', minGradeFilter.value);
            }
            
            const positiveEvOnly = document.getElementById('positiveEvOnly');
            if (positiveEvOnly && positiveEvOnly.checked) {
                params.append('positive_ev_only', 'true');
            }
            
            const excludeInjuries = document.getElementById('excludeInjuries');
            if (excludeInjuries && excludeInjuries.checked) {
                params.append('exclude_injuries', 'true');
            }
            
            const excludeRotation = document.getElementById('excludeRotation');
            if (excludeRotation && excludeRotation.checked) {
                params.append('exclude_rotation', 'true');
            }
            
            return params.toString();
        }

        async function refreshData() {
            // Debounce: prevent multiple simultaneous refreshes
            if (isRefreshing) {
                console.log('Refresh already in progress, skipping...');
                return Promise.resolve();
            }
            
            isRefreshing = true;
            const refreshBtn = document.getElementById('refreshBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const showAllToggle = document.getElementById('showAllToggle');
            const showAll = showAllToggle ? showAllToggle.checked : false;
            
            if (refreshBtn) refreshBtn.disabled = true;
            if (loadingIndicator) loadingIndicator.style.display = 'inline';
            
            try {
                const filterParams = buildFilterParams();
                const url = '/api/edges' + (filterParams ? '?' + filterParams : '');
                const response = await fetch(url);
                const data = await response.json();
                updatePage(data);
                return Promise.resolve(data); // Return data for chaining
            } catch (error) {
                const errorContainer = document.getElementById('errorContainer');
                if (errorContainer) {
                    errorContainer.innerHTML = 
                        `<div class="error-message"><strong>Error:</strong> Failed to fetch data: ${error.message}</div>`;
                }
                return Promise.reject(error);
            } finally {
                if (refreshBtn) refreshBtn.disabled = false;
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                isRefreshing = false;  // Reset flag
            }
        }

        function toggleShowAll() {
            refreshData();
        }

        function changeStatType() {
            const statType = document.getElementById('statTypeSelect').value;
            const statDesc = document.getElementById('statDescription');
            
            // Update description
            const statCategories = {{ stat_categories|tojson }};
            if (statCategories[statType]) {
                statDesc.textContent = statCategories[statType].description;
            }
            
            // Refresh data with new stat type
            refreshData();
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            if (checkbox.checked) {
                // Start auto-refresh
                autoRefreshInterval = setInterval(refreshData, REFRESH_INTERVAL);
                console.log('Auto-refresh enabled');
            } else {
                // Stop auto-refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                console.log('Auto-refresh disabled');
            }
        }

        // Load ALL active players (not just relevant ones) - unified function
        async function loadAllPlayers() {
            const btn = document.getElementById('loadAllBtn');
            if (!btn) return;
            
            if (!confirm('This will load ALL active NBA players (500+ players).\n\n' +
                        'This takes 10-15 minutes due to API rate limits.\n\n' +
                        'The page will auto-refresh every 30 seconds to show progress.\n\n' +
                        'Continue?')) {
                return;
            }
            
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ Loading All Players...';
            
            try {
                const statType = document.getElementById('statTypeSelect')?.value || 'PTS';
                const response = await fetch('/api/load-all-players', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        stat_type: statType,
                        season: '2023-24'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Player loading started in background!\n\n' + 
                          'This will take 10-15 minutes.\n\n' +
                          'The page will auto-refresh every 30 seconds to show progress.\n' +
                          'You can continue using the app while it loads.');
                    
                    // Refresh data after 30 seconds to check progress
                    setTimeout(() => {
                        refreshData();
                    }, 30000);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to start loading'));
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        // Check projections status on page load
        async function checkProjectionsStatus() {
            try {
                const response = await fetch('/api/projections');
                const data = await response.json();
                
                if (data.is_default_only) {
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'warning-banner';
                    warningDiv.style.cssText = 'background: rgba(243, 156, 18, 0.2); border: 2px solid #f39c12; padding: 15px; margin: 20px 0; border-radius: 8px; text-align: center;';
                    warningDiv.innerHTML = `
                        <strong style="color: #f39c12; font-size: 1.1em;">‚ö†Ô∏è Only Default Players Loaded</strong><br>
                        <p>Currently showing only ${data.count} default players: ${data.default_players.join(', ')}</p>
                        <p><strong>Click "üì• Load All Active Players" button to load 100+ active NBA players.</strong></p>
                        <p style="font-size: 0.9em; color: #888;">This takes 10-15 minutes but runs in background.</p>
                    `;
                    const container = document.querySelector('.container');
                    if (container) {
                        container.insertBefore(warningDiv, container.firstChild);
                    }
                }
            } catch (error) {
                console.error('Error checking projections status:', error);
            }
        }
        
        async function checkPlayerCount() {
            const loadBtn = document.getElementById('loadPlayersBtn');
            const progressDiv = document.getElementById('loadProgress');
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            if (!confirm('This will load ALL active NBA players and may take 10-15 minutes due to API rate limits. Continue?')) {
                return;
            }
            
            loadBtn.disabled = true;
            progressDiv.style.display = 'block';
            progressText.textContent = 'Starting to load all active players...';
            progressFill.style.width = '0%';
            
            try {
                const response = await fetch('/api/load-all-players', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        season: '2023-24',
                        stat_type: 'PTS'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    progressFill.style.width = '100%';
                    progressText.textContent = `Successfully loaded ${data.count} players!`;
                    
                    // Refresh the page data after a short delay
                    setTimeout(() => {
                        refreshData();
                        progressDiv.style.display = 'none';
                        alert(`Successfully loaded ${data.count} active NBA players!`);
                    }, 2000);
                } else {
                    progressText.textContent = `Error: ${data.error}`;
                    alert(`Error loading players: ${data.error}`);
                }
            } catch (error) {
                progressText.textContent = `Error: ${error.message}`;
                alert(`Failed to load players: ${error.message}`);
            } finally {
                loadBtn.disabled = false;
            }
        }

        function toggleFactors(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function togglePhase2(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        // Line Management Functions
        function showLineManagement() {
            try {
                const panel = document.getElementById('lineManagementPanel');
                if (!panel) {
                    console.error('lineManagementPanel element not found');
                    alert('Line Management panel not found. Please refresh the page.');
                    return;
                }
                panel.style.display = 'block';
                if (typeof loadLineChanges === 'function') loadLineChanges();
                if (typeof loadChaseList === 'function') loadChaseList();
                if (typeof loadAltLines === 'function') loadAltLines();
                if (typeof loadDailyUpdateStatus === 'function') loadDailyUpdateStatus();
            } catch (error) {
                console.error('Error showing line management:', error);
                alert('Error opening Line Management: ' + error.message);
            }
        }

        function hideLineManagement() {
            document.getElementById('lineManagementPanel').style.display = 'none';
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadLineChanges() {
            try {
                const response = await fetch('/api/line-changes');
                const data = await response.json();
                const container = document.getElementById('lineChangesContainer');
                
                if (data.changes && Object.keys(data.changes).length > 0) {
                    container.innerHTML = Object.entries(data.changes).map(([player, change]) => `
                        <div class="line-change-card">
                            <div class="change-player">${player}</div>
                            <div class="change-details">
                                <span class="old-line">${change.previous}</span>
                                <span class="arrow">‚Üí</span>
                                <span class="new-line">${change.current}</span>
                                <span class="movement ${change.direction}">${change.movement > 0 ? '+' : ''}${change.movement}</span>
                            </div>
                            <div class="change-direction">Line moved ${change.direction}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="no-data">No line changes detected in last 24h</p>';
                }
            } catch (error) {
                console.error('Error loading line changes:', error);
            }
        }

        async function loadChaseList() {
            try {
                const response = await fetch('/api/chase-list');
                const data = await response.json();
                const container = document.getElementById('chaseListContainer');
                
                if (data.chase_list && data.chase_list.length > 0) {
                    container.innerHTML = data.chase_list.map(item => `
                        <div class="chase-item">
                            <div class="chase-player">${item.player}</div>
                            <div class="chase-line">Line: ${item.line} ${item.stat_type}</div>
                            <div class="chase-reason">${item.reason || 'No reason provided'}</div>
                            <button onclick="removeFromChase('${item.player}', '${item.stat_type}')" class="remove-btn">Remove</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="no-data">No props in chase list</p>';
                }
            } catch (error) {
                console.error('Error loading chase list:', error);
            }
        }

        async function loadAltLines() {
            try {
                const response = await fetch('/api/alt-lines');
                const data = await response.json();
                const container = document.getElementById('altLinesContainer');
                
                if (data.alt_lines && Object.keys(data.alt_lines).length > 0) {
                    container.innerHTML = Object.entries(data.alt_lines).map(([player, lines]) => `
                        <div class="alt-line-card">
                            <div class="alt-player">${player}</div>
                            ${lines.map(line => `
                                <div class="alt-line-item">
                                    <span>Main: ${line.main_line}</span>
                                    <span>Alt: ${line.alt_line}</span>
                                    <span class="diff">Diff: ${line.difference > 0 ? '+' : ''}${line.difference}</span>
                                    <span class="source">${line.source || 'Unknown'}</span>
                                </div>
                            `).join('')}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="no-data">No alternative lines tracked</p>';
                }
            } catch (error) {
                console.error('Error loading alt lines:', error);
            }
        }

        async function updateLine() {
            const player = document.getElementById('editPlayerSelect').value;
            const oldLine = parseFloat(document.getElementById('oldLineInput').value);
            const newLine = parseFloat(document.getElementById('newLineInput').value);
            
            if (!player || isNaN(oldLine) || isNaN(newLine)) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch('/api/update-line', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player: player,
                        old_line: oldLine,
                        new_line: newLine,
                        stat_type: 'PTS'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('editResult').innerHTML = 
                        `<div class="success-msg">‚úÖ ${data.message}</div>`;
                    // Clear inputs
                    document.getElementById('oldLineInput').value = '';
                    document.getElementById('newLineInput').value = '';
                    // Refresh data
                    refreshData();
                } else {
                    document.getElementById('editResult').innerHTML = 
                        `<div class="error-msg">‚ùå ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('editResult').innerHTML = 
                    `<div class="error-msg">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function removeFromChase(player, statType) {
            try {
                const response = await fetch('/api/chase-list', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({player: player, stat_type: statType})
                });
                
                if (response.ok) {
                    loadChaseList();
                }
            } catch (error) {
                console.error('Error removing from chase list:', error);
            }
        }

        async function loadDailyUpdateStatus() {
            try {
                const response = await fetch('/api/daily-update-status');
                const data = await response.json();
                const statusEl = document.getElementById('dailyUpdateStatus');
                
                if (data.daily_update_scheduled && data.next_run) {
                    const nextRun = new Date(data.next_run);
                    const now = new Date();
                    const hoursUntil = Math.floor((nextRun - now) / (1000 * 60 * 60));
                    const minsUntil = Math.floor(((nextRun - now) % (1000 * 60 * 60)) / (1000 * 60));
                    
                    statusEl.textContent = `‚è∞ Next update: ${hoursUntil}h ${minsUntil}m`;
                    statusEl.style.color = '#ffd700';
                } else {
                    statusEl.textContent = '‚è∞ Daily update: Not scheduled';
                    statusEl.style.color = '#888';
                }
            } catch (error) {
                console.error('Error loading update status:', error);
            }
        }

        // Tactical Filters Functions
        function showTacticalFilters() {
            try {
                const panel = document.getElementById('tacticalFiltersPanel');
                if (!panel) {
                    console.error('tacticalFiltersPanel element not found');
                    alert('Tactical Filters panel not found. Please refresh the page.');
                    return;
                }
                panel.style.display = 'block';
            } catch (error) {
                console.error('Error showing tactical filters:', error);
                alert('Error opening Tactical Filters: ' + error.message);
            }
        }

        function hideTacticalFilters() {
            document.getElementById('tacticalFiltersPanel').style.display = 'none';
            // Apply filters when closing
            refreshData();
        }

        function applyFilters() {
            // Refresh data with current filter settings
            refreshData();
        }

        function resetFilters() {
            // Reset all filter inputs to defaults
            const minProbFilter = document.getElementById('minProbFilter');
            if (minProbFilter) {
                minProbFilter.value = 70;
                document.getElementById('probValue').textContent = '70';
            }
            
            const minEvFilter = document.getElementById('minEvFilter');
            if (minEvFilter) {
                minEvFilter.value = 0;
                document.getElementById('evValue').textContent = '0';
            }
            
            const minEdgeFilter = document.getElementById('minEdgeFilter');
            if (minEdgeFilter) {
                minEdgeFilter.value = 0;
                document.getElementById('edgeValue').textContent = '0';
            }
            
            const minGradeFilter = document.getElementById('minGradeFilter');
            if (minGradeFilter) {
                minGradeFilter.value = 'B';
            }
            
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) {
                sortSelect.value = 'ev';
            }
            
            const positiveEvOnly = document.getElementById('positiveEvOnly');
            if (positiveEvOnly) {
                positiveEvOnly.checked = false;
            }
            
            const excludeInjuries = document.getElementById('excludeInjuries');
            if (excludeInjuries) {
                excludeInjuries.checked = false;
            }
            
            const excludeRotation = document.getElementById('excludeRotation');
            if (excludeRotation) {
                excludeRotation.checked = false;
            }
            
            // Apply reset filters
            refreshData();
        }

        // Add to Chase List function
        async function addToChaseList(player, statType, line) {
            try {
                const response = await fetch('/api/chase-list', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player: player,
                        stat_type: statType || 'PTS',
                        line: line
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Added to chase list');
                    loadChaseList();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to add'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Add Alt Line function
        async function addAltLine(player, mainLine, altLine, statType, source) {
            try {
                const response = await fetch('/api/alt-lines', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player: player,
                        main_line: mainLine,
                        alt_line: altLine,
                        stat_type: statType || 'PTS',
                        source: source || 'Manual'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Alternative line added');
                    loadAltLines();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to add'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Pagination state
        let currentPage = 1;
        const itemsPerPage = 50;
        let allEdges = [];
        
        function renderEdgesWithPagination(edges) {
            allEdges = edges;
            const totalPages = Math.ceil(edges.length / itemsPerPage);
            currentPage = Math.min(currentPage, totalPages || 1);
            
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageEdges = edges.slice(startIdx, endIdx);
            
            const edgesContainer = document.getElementById('edgesContainer');
            const showing70Plus = !document.getElementById('showAllToggle')?.checked;
            
            if (pageEdges.length > 0) {
                edgesContainer.innerHTML = `
                    <div class="edges-section">
                        <div class="section-header">
                            <h2>${showing70Plus ? '70%+ PROBABILITY PROPS' : 'ALL EDGES'} (<span id="edgeCount">${edges.length}</span>)</h2>
                            ${totalPages > 1 ? `
                            <div class="pagination-controls">
                                <button onclick="previousPage()" id="prevBtn" class="page-btn" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Previous</button>
                                <span id="pageInfo">Page ${currentPage} of ${totalPages} (${startIdx + 1}-${Math.min(endIdx, edges.length)} of ${edges.length})</span>
                                <button onclick="nextPage()" id="nextBtn" class="page-btn" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>
                            </div>
                            ` : ''}
                        </div>
                        <p class="section-subtitle">${showing70Plus ? 'Only showing props with 70%+ hit probability from all active NBA players' : 'Showing all edges (including below 70%)'}</p>
                        <div class="edges-grid" id="edgesGrid">
                            ${pageEdges.map(edge => renderEdgeCard(edge)).join('')}
                        </div>
                    </div>
                `;
            } else {
                edgesContainer.innerHTML = `
                    <div class="no-edges">
                        <p>No edges found with current threshold.</p>
                    </div>
                `;
            }
        }
        
        function renderEdgeCard(edge) {
            // This is a simplified version - you may need to adjust based on your actual edge structure
            return `
                <div class="oracle-card ${edge.recommendation?.toLowerCase() || ''}">
                    <div class="oracle-header-row">
                        <div class="oracle-player">${edge.player || 'N/A'}</div>
                        ${edge.ev ? `<div class="ev-badge ${edge.ev.is_positive_ev ? 'positive-ev' : 'negative-ev'}">EV: $${edge.ev.ev?.toFixed(2) || '0.00'}</div>` : ''}
                        ${edge.matchup_grade ? `<div class="grade-badge grade-${edge.matchup_grade.grade?.toLowerCase().replace('+', 'plus').replace('-', 'minus')}">${edge.matchup_grade.grade}</div>` : ''}
                    </div>
                    ${edge.oracle ? `
                    <div class="oracle-content">
                        <div class="oracle-line"><strong>The Line:</strong> ${edge.oracle.verdict || edge.line || 'N/A'}</div>
                        <div class="oracle-sharp"><strong>The Sharp Angle:</strong> ${edge.oracle.sharp_angle || 'N/A'}</div>
                        <div class="oracle-key"><strong>Key Data Point:</strong> ${edge.oracle.key_data || 'N/A'}</div>
                        <div class="oracle-verdict"><strong>The Verdict:</strong> ${edge.oracle.verdict || 'N/A'}</div>
                        <div class="oracle-confidence"><strong>Confidence:</strong> <span class="confidence-badge confidence-${Math.floor(edge.oracle.confidence || 1)}">${edge.oracle.confidence || 1} Units</span></div>
                        <div class="oracle-risk"><strong>Risk Factor:</strong> ${edge.oracle.risk_factor || 'N/A'}</div>
                    </div>
                    ` : `
                    <div class="edge-details">
                        <div class="stat-row"><span class="label">Line:</span><span class="value">${edge.line || 'N/A'}</span></div>
                        <div class="stat-row"><span class="label">L5 Avg:</span><span class="value">${edge.average || 'N/A'}</span></div>
                        <div class="recommendation"><strong>${edge.recommendation || 'N/A'}</strong></div>
                    </div>
                    `}
                    ${edge.streak && edge.streak.active ? `<div class="streak-badge streak-${edge.streak.streak_type?.toLowerCase()}">üî• ${edge.streak.streak_count}-game ${edge.streak.streak_type} streak</div>` : ''}
                </div>
            `;
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderEdgesWithPagination(allEdges);
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(allEdges.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderEdgesWithPagination(allEdges);
            }
        }

        // Initial load timestamp
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date().toLocaleString();
            document.getElementById('lastUpdate').textContent = `Last updated: ${now}`;
            loadDailyUpdateStatus();
            // Refresh status every minute
            setInterval(loadDailyUpdateStatus, 60000);
            // Track player count to detect when new players are loaded
            let lastPlayerCount = {{ projections|length }};
            
            // Auto-refresh edges every 15 seconds to catch background updates faster
            // This ensures newly loaded players appear quickly
            setInterval(() => {
                if (typeof refreshData === 'function') {
                    refreshData().then((data) => {
                        // Check if player count increased (new players loaded)
                        const currentCount = data?.total_players_loaded || data?.projections_count || parseInt(document.getElementById('totalPlayers')?.textContent || '0');
                        if (currentCount > lastPlayerCount && lastPlayerCount >= 0) {
                            const newPlayers = currentCount - lastPlayerCount;
                            console.log(`‚úÖ New players detected! Count increased from ${lastPlayerCount} to ${currentCount}`);
                            lastPlayerCount = currentCount;
                            // Show a notification
                            const notification = document.createElement('div');
                            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 15px 20px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-weight: bold; font-size: 14px;';
                            notification.textContent = `‚úÖ ${newPlayers} new player${newPlayers > 1 ? 's' : ''} loaded!`;
                            document.body.appendChild(notification);
                            setTimeout(() => notification.remove(), 5000);
                        } else if (currentCount !== lastPlayerCount) {
                            lastPlayerCount = currentCount;
                        }
                    }).catch(err => {
                        console.error('Error refreshing:', err);
                    });
                }
            }, 15000); // Reduced to 15 seconds for faster updates
            // Load glitched props scan status
            loadGlitchedScanStatus();
            // Refresh scan status every 5 minutes
            setInterval(loadGlitchedScanStatus, 300000);
        });
    </script>
    <script src="{{ url_for('static', filename='parlay_ui.js') }}"></script>
</body>
</html>
