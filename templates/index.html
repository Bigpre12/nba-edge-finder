<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Edge Finder</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>THE ORACLE</h1>
            <p class="subtitle">Sharp angles. No fluff. Pure edge. | Showing 70%+ probability props only</p>
            <p class="player-count">Loaded: <span id="totalPlayers">{{ projections|length }}</span> active players | Filtered to: <span id="filteredCount">{{ edges|length }}</span> props (70%+)</p>
        </header>

        {% if error %}
        <div class="error-message">
            <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        <div class="controls">
            <button onclick="refreshData()" class="refresh-btn" id="refreshBtn">üîÑ Refresh Edges</button>
            <label class="auto-refresh-toggle">
                <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                <span>Auto-refresh (60s)</span>
            </label>
            <button onclick="loadAllActivePlayers()" class="load-players-btn" id="loadPlayersBtn">üì• Load All Active Players</button>
            <button onclick="showLineManagement()" class="line-mgmt-btn" id="lineMgmtBtn">üìä Line Management</button>
            <button onclick="showParlayCalculator()" class="parlay-btn" id="parlayBtn">üé≤ Parlay Calculator</button>
            <label class="filter-toggle">
                <input type="checkbox" id="showAllToggle" onchange="toggleShowAll()">
                <span>Show All Edges (not just 70%+)</span>
            </label>
            <button onclick="showTacticalFilters()" class="filter-btn" id="filterBtn">üîç Tactical Filters</button>
        </div>

        <!-- Tactical Filters Panel -->
        <div id="tacticalFiltersPanel" class="tactical-filters-panel" style="display: none;">
            <div class="filters-header">
                <h3>üîç Tactical Filters & Sorting</h3>
                <button onclick="hideTacticalFilters()" class="close-btn">‚úï</button>
            </div>
            
            <div class="filters-content">
                <div class="filters-section">
                    <h4>Sort By</h4>
                    <select id="sortSelect" onchange="applyFilters()" class="filter-select">
                        <option value="ev">Expected Value (EV)</option>
                        <option value="market_edge">Market Edge %</option>
                        <option value="probability">Probability</option>
                        <option value="grade">Matchup Grade</option>
                        <option value="edge">Edge Size</option>
                        <option value="kelly">Kelly Criterion</option>
                    </select>
                </div>
                
                <div class="filters-section">
                    <h4>Filters</h4>
                    <div class="filter-group">
                        <label>Min Probability: <span id="probValue">70</span>%</label>
                        <input type="range" id="minProbFilter" min="50" max="95" value="70" oninput="document.getElementById('probValue').textContent = this.value; applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Min EV: $<span id="evValue">0</span></label>
                        <input type="range" id="minEvFilter" min="0" max="50" value="0" oninput="document.getElementById('evValue').textContent = this.value; applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Min Market Edge: <span id="edgeValue">0</span>%</label>
                        <input type="range" id="minEdgeFilter" min="0" max="20" value="0" oninput="document.getElementById('edgeValue').textContent = this.value; applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Min Grade:</label>
                        <select id="minGradeFilter" onchange="applyFilters()" class="filter-select">
                            <option value="">Any</option>
                            <option value="A+">A+</option>
                            <option value="A">A</option>
                            <option value="B+">B+</option>
                            <option value="B" selected>B</option>
                            <option value="C+">C+</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="positiveEvOnly" onchange="applyFilters()">
                            Positive EV Only
                        </label>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="excludeInjuries" onchange="applyFilters()">
                            Exclude Injury Risks
                        </label>
                    </div>
                    <div class="filter-group">
                        <label>
                            <input type="checkbox" id="excludeRotation" onchange="applyFilters()">
                            Exclude Rotation Changes
                        </label>
                    </div>
                </div>
                
                <div class="filters-actions">
                    <button onclick="resetFilters()" class="reset-btn">Reset Filters</button>
                    <button onclick="hideTacticalFilters()" class="apply-btn">Apply</button>
                </div>
            </div>
        </div>

        <div id="loadProgress" class="load-progress" style="display: none;">
            <div class="progress-content">
                <p id="progressText">Loading all active NBA players...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-note">This may take several minutes due to API rate limits. Please keep this page open.</p>
            </div>
        </div>

        <div class="status-bar">
            <span id="lastUpdate">Last updated: {{ "Now" if edges else "Never" }}</span>
            <span id="loadingIndicator" class="loading" style="display: none;">‚è≥ Updating...</span>
            <span id="dailyUpdateStatus" class="daily-status"></span>
        </div>

        <!-- Line Management Panel -->
        <div id="lineManagementPanel" class="line-management-panel" style="display: none;">
            <div class="panel-header">
                <h3>üìä Line Management</h3>
                <button onclick="hideLineManagement()" class="close-btn">‚úï</button>
            </div>
            
            <div class="panel-tabs">
                <button class="tab-btn active" onclick="showTab('line-changes')">Line Changes</button>
                <button class="tab-btn" onclick="showTab('chase-list')">Chase List</button>
                <button class="tab-btn" onclick="showTab('alt-lines')">Alt Lines</button>
                <button class="tab-btn" onclick="showTab('edit-lines')">Edit Lines</button>
            </div>

            <!-- Line Changes Tab -->
            <div id="tab-line-changes" class="tab-content active">
                <h4>Line Changes (Last 24h)</h4>
                <div id="lineChangesContainer"></div>
                <button onclick="loadLineChanges()" class="refresh-btn">üîÑ Refresh Changes</button>
            </div>

            <!-- Chase List Tab -->
            <div id="tab-chase-list" class="tab-content">
                <h4>Props to Chase</h4>
                <div id="chaseListContainer"></div>
                <button onclick="loadChaseList()" class="refresh-btn">üîÑ Refresh</button>
            </div>

            <!-- Alt Lines Tab -->
            <div id="tab-alt-lines" class="tab-content">
                <h4>Alternative Lines</h4>
                <div id="altLinesContainer"></div>
                <button onclick="loadAltLines()" class="refresh-btn">üîÑ Refresh</button>
            </div>

            <!-- Edit Lines Tab -->
            <div id="tab-edit-lines" class="tab-content">
                <h4>Edit Lines (Even After Send-Off)</h4>
                <div class="edit-lines-form">
                    <select id="editPlayerSelect" class="player-select">
                        <option value="">Select Player...</option>
                        {% for player in projections.keys() %}
                        <option value="{{ player }}">{{ player }}</option>
                        {% endfor %}
                    </select>
                    <input type="number" id="oldLineInput" step="0.5" placeholder="Old Line" class="line-input">
                    <input type="number" id="newLineInput" step="0.5" placeholder="New Line" class="line-input">
                    <button onclick="updateLine()" class="update-btn">Update Line</button>
                </div>
                <div id="editResult"></div>
            </div>
        </div>

        <div id="errorContainer"></div>

        <div id="edgesContainer">
            {% if edges %}
                <div class="edges-section">
                    <h2>70%+ PROBABILITY PROPS (<span id="edgeCount">{{ edges|length }}</span>)</h2>
                    <p class="section-subtitle">Only showing props with 70%+ hit probability from all active NBA players</p>
                    <div class="edges-grid" id="edgesGrid">
                        {% for edge in edges %}
                        <div class="oracle-card {{ edge.recommendation|lower }}">
                            <div class="oracle-header-row">
                                <div class="oracle-player">{{ edge.player }}</div>
                                {% if edge.ev %}
                                <div class="ev-badge {% if edge.ev.is_positive_ev %}positive-ev{% else %}negative-ev{% endif %}">
                                    EV: ${{ edge.ev.ev|round(2) }}
                                </div>
                                {% endif %}
                                {% if edge.matchup_grade %}
                                <div class="grade-badge grade-{{ edge.matchup_grade.grade|lower|replace('+', 'plus')|replace('-', 'minus') }}">
                                    {{ edge.matchup_grade.grade }}
                                </div>
                                {% endif %}
                            </div>
                            {% if edge.oracle %}
                            <div class="oracle-content">
                                <div class="oracle-line">
                                    <strong>The Line:</strong> {{ edge.oracle.verdict }}
                                </div>
                                <div class="oracle-sharp">
                                    <strong>The Sharp Angle:</strong> {{ edge.oracle.sharp_angle }}
                                </div>
                                <div class="oracle-key">
                                    <strong>Key Data Point:</strong> {{ edge.oracle.key_data }}
                                </div>
                                <div class="oracle-verdict">
                                    <strong>The Verdict:</strong> {{ edge.oracle.verdict }}
                                </div>
                                <div class="oracle-confidence">
                                    <strong>Confidence:</strong> 
                                    <span class="confidence-badge confidence-{{ edge.oracle.confidence|int }}">
                                        {{ edge.oracle.confidence }} Units
                                    </span>
                                </div>
                                <div class="oracle-risk">
                                    <strong>Risk Factor:</strong> {{ edge.oracle.risk_factor }}
                                </div>
                                {% if edge.advanced_metrics %}
                                <div class="advanced-metrics">
                                    <div class="metrics-row">
                                        <span>FG%:</span> <span>{{ edge.advanced_metrics.fg_pct }}%</span>
                                        <span>Pts/36:</span> <span>{{ edge.advanced_metrics.points_per_36 }}</span>
                                        <span>CV:</span> <span>{{ edge.advanced_metrics.consistency }}%</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="edge-details">
                                <div class="stat-row">
                                    <span class="label">Line:</span>
                                    <span class="value">{{ edge.line }}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="label">L5 Avg:</span>
                                    <span class="value">{{ edge.average }}</span>
                                </div>
                                <div class="recommendation">
                                    <strong>{{ edge.recommendation }}</strong>
                                </div>
                            </div>
                            {% endif %}
                            {% if edge.streak and edge.streak.active %}
                            <div class="streak-badge streak-{{ edge.streak.streak_type|lower }}">
                                üî• {{ edge.streak.streak_count }}-game {{ edge.streak.streak_type }} streak
                            </div>
                            {% endif %}
                                {% if edge.factors %}
                                <div class="performance-factors">
                                    <div class="factors-header" onclick="toggleFactors(this)">
                                        <span>üìä Performance Factors</span>
                                        <span class="toggle-icon">‚ñº</span>
                                    </div>
                                    <div class="factors-content" style="display: none;">
                                        {% if edge.factors.injury_risk %}
                                        <div class="factor-badge factor-warning">
                                            ‚ö†Ô∏è Injury Risk ({{ edge.factors.dnp_count }} DNP game{{ 's' if edge.factors.dnp_count != 1 else '' }})
                                        </div>
                                        {% endif %}
                                        {% if edge.factors.rotation_change %}
                                        <div class="factor-badge factor-info">
                                            üîÑ Rotation Change ({{ edge.factors.recent_minutes_avg }} min recent vs {{ edge.factors.older_minutes_avg }} min earlier)
                                        </div>
                                        {% endif %}
                                        <div class="factor-row">
                                            <span class="factor-label">Minutes Trend:</span>
                                            <span class="factor-value trend-{{ edge.factors.minutes_trend }}">
                                                {{ edge.factors.recent_minutes_avg }} min ({{ edge.factors.minutes_trend }})
                                            </span>
                                        </div>
                                        <div class="factor-row">
                                            <span class="factor-label">Performance Trend:</span>
                                            <span class="factor-value trend-{{ edge.factors.performance_trend }}">
                                                {{ edge.factors.performance_trend|title }}
                                            </span>
                                        </div>
                                        {% if edge.factors.shooting_efficiency %}
                                        <div class="factor-row">
                                            <span class="factor-label">FG% (L5):</span>
                                            <span class="factor-value">{{ edge.factors.shooting_efficiency }}%</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <div class="no-edges">
                    <p>No edges found with current threshold.</p>
                    <p class="info">Checked <span id="playerCount">{{ projections|length }}</span> players. Adjust threshold or check projections.</p>
                </div>
            {% endif %}
        </div>

        <!-- Parlay Recommendations Section -->
        <div id="parlaySection" class="parlay-section" style="display: none;">
            <h2>üé≤ PARLAY RECOMMENDATIONS</h2>
            <p class="section-subtitle">Best parlay combinations based on 70%+ probability props</p>
            
            <div class="parlay-tabs">
                <button class="parlay-tab active" onclick="showParlayTab('2-man')">2-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('3-man')">3-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('4-man')">4-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('6-man')">6-Man</button>
            </div>
            
            <div id="parlay-2-man" class="parlay-tab-content active">
                <h3>2-Man Parlays</h3>
                <div id="parlay2ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-3-man" class="parlay-tab-content">
                <h3>3-Man Parlays</h3>
                <div id="parlay3ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-4-man" class="parlay-tab-content">
                <h3>4-Man Parlays</h3>
                <div id="parlay4ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-6-man" class="parlay-tab-content">
                <h3>6-Man Parlays</h3>
                <div id="parlay6ManContainer" class="parlay-container"></div>
            </div>
        </div>

        <!-- Parlay Calculator Modal -->
        <div id="parlayCalculatorModal" class="parlay-modal" style="display: none;">
            <div class="parlay-modal-content">
                <div class="parlay-modal-header">
                    <h2>üé≤ Parlay Calculator</h2>
                    <button onclick="hideParlayCalculator()" class="close-btn">‚úï</button>
                </div>
                <div class="parlay-calculator-body">
                    <div class="calculator-inputs">
                        <h3>Add Bets</h3>
                        <div id="betsList"></div>
                        <button onclick="addBetRow()" class="add-bet-btn">+ Add Bet</button>
                        <div class="calculator-results">
                            <h3>Parlay Results</h3>
                            <div id="calculatorResults"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="highProbContainer">
            {% if high_prob_props %}
                <div class="high-prob-section">
                    <h2>üéØ HIGH PROBABILITY PROPS (70%+) - <span id="highProbCount">{{ high_prob_props|length }}</span></h2>
                    <p class="section-subtitle">PrizePicks/Underdog Format | Sorted by Probability</p>
                    <div class="high-prob-grid" id="highProbGrid">
                        {% for prop in high_prob_props %}
                        <div class="high-prob-card">
                            <div class="prob-header">
                                <div class="prob-badge">{{ prop.probability }}%</div>
                                <div class="prizepicks-display">{{ prop.prizepicks.display }}</div>
                            </div>
                            <div class="prob-details">
                                <div class="prob-reasoning">
                                    <strong>Reasoning:</strong> {{ prop.reasoning }}
                                </div>
                                <div class="prob-stats">
                                    <div class="stat-item">
                                        <span>L5 Average:</span>
                                        <span>{{ prop.edge.average }}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Line:</span>
                                        <span>{{ prop.edge.line }}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span>Edge:</span>
                                        <span class="edge-value">{{ prop.edge.difference }}pts</span>
                                    </div>
                                </div>
                                {% if prop.edge.streak and prop.edge.streak.active %}
                                <div class="streak-indicator">
                                    üî• {{ prop.edge.streak.streak_count }}-game {{ prop.edge.streak.streak_type }} streak
                                </div>
                                {% endif %}
                                {% if prop.beneficiary %}
                                <div class="matchup-indicator">
                                    ‚ö° vs {{ prop.beneficiary.opponent }}: {{ prop.beneficiary.mismatch }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Parlay Recommendations Section -->
        <div id="parlaySection" class="parlay-section" style="display: none;">
            <h2>üé≤ PARLAY RECOMMENDATIONS</h2>
            <p class="section-subtitle">Best parlay combinations based on 70%+ probability props</p>
            
            <div class="parlay-tabs">
                <button class="parlay-tab active" onclick="showParlayTab('2-man')">2-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('3-man')">3-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('4-man')">4-Man</button>
                <button class="parlay-tab" onclick="showParlayTab('6-man')">6-Man</button>
            </div>
            
            <div id="parlay-2-man" class="parlay-tab-content active">
                <h3>2-Man Parlays</h3>
                <div id="parlay2ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-3-man" class="parlay-tab-content">
                <h3>3-Man Parlays</h3>
                <div id="parlay3ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-4-man" class="parlay-tab-content">
                <h3>4-Man Parlays</h3>
                <div id="parlay4ManContainer" class="parlay-container"></div>
            </div>
            <div id="parlay-6-man" class="parlay-tab-content">
                <h3>6-Man Parlays</h3>
                <div id="parlay6ManContainer" class="parlay-container"></div>
            </div>
        </div>

        <!-- Parlay Calculator Modal -->
        <div id="parlayCalculatorModal" class="parlay-modal" style="display: none;">
            <div class="parlay-modal-content">
                <div class="parlay-modal-header">
                    <h2>üé≤ Parlay Calculator</h2>
                    <button onclick="hideParlayCalculator()" class="close-btn">‚úï</button>
                </div>
                <div class="parlay-calculator-body">
                    <div class="calculator-inputs">
                        <h3>Add Bets</h3>
                        <div id="betsList"></div>
                        <button onclick="addBetRow()" class="add-bet-btn">+ Add Bet</button>
                        <div class="calculator-results">
                            <h3>Parlay Results</h3>
                            <div id="calculatorResults"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="streaksContainer">
            {% if streaks %}
                <div class="streaks-section">
                    <h2>üî• Active Streaks (<span id="streakCount">{{ streaks|length }}</span>)</h2>
                    <p class="section-subtitle">Players consistently hitting OVER/UNDER for 2+ games</p>
                    <div class="streaks-grid" id="streaksGrid">
                        {% for streak in streaks %}
                        <div class="streak-card streak-{{ streak.streak_type|lower }}">
                            <div class="player-name">{{ streak.player }}</div>
                            <div class="streak-details">
                                <div class="stat-row">
                                    <span class="label">Line:</span>
                                    <span class="value">{{ streak.line }}</span>
                                </div>
                                {% if streak.average %}
                                <div class="stat-row">
                                    <span class="label">L5 Average:</span>
                                    <span class="value">{{ streak.average }}</span>
                                </div>
                                {% endif %}
                                <div class="streak-info">
                                    <div class="streak-badge-large streak-{{ streak.streak_type|lower }}">
                                        üî• {{ streak.streak_count }}-game {{ streak.streak_type }} streak
                                    </div>
                                </div>
                                {% if streak.factors %}
                                <div class="performance-factors">
                                    <div class="factors-header" onclick="toggleFactors(this)">
                                        <span>üìä Performance Factors</span>
                                        <span class="toggle-icon">‚ñº</span>
                                    </div>
                                    <div class="factors-content" style="display: none;">
                                        {% if streak.factors.injury_risk %}
                                        <div class="factor-badge factor-warning">
                                            ‚ö†Ô∏è Injury Risk ({{ streak.factors.dnp_count }} DNP game{{ 's' if streak.factors.dnp_count != 1 else '' }})
                                        </div>
                                        {% endif %}
                                        {% if streak.factors.rotation_change %}
                                        <div class="factor-badge factor-info">
                                            üîÑ Rotation Change ({{ streak.factors.recent_minutes_avg }} min recent vs {{ streak.factors.older_minutes_avg }} min earlier)
                                        </div>
                                        {% endif %}
                                        <div class="factor-row">
                                            <span class="factor-label">Minutes Trend:</span>
                                            <span class="factor-value trend-{{ streak.factors.minutes_trend }}">
                                                {{ streak.factors.recent_minutes_avg }} min ({{ streak.factors.minutes_trend }})
                                            </span>
                                        </div>
                                        <div class="factor-row">
                                            <span class="factor-label">Performance Trend:</span>
                                            <span class="factor-value trend-{{ streak.factors.performance_trend }}">
                                                {{ streak.factors.performance_trend|title }}
                                            </span>
                                        </div>
                                        {% if streak.factors.shooting_efficiency %}
                                        <div class="factor-row">
                                            <span class="factor-label">FG% (L5):</span>
                                            <span class="factor-value">{{ streak.factors.shooting_efficiency }}%</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="projections-section">
            <div class="projections-header">
                <h3>Current Projections (<span id="projectionCount">{{ projections|length }}</span> players)</h3>
                <input type="text" id="playerSearch" placeholder="üîç Search players..." class="player-search" onkeyup="filterPlayers()">
            </div>
            <div class="table-container">
                <table class="projections-table" id="projectionsTable">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Line</th>
                        </tr>
                    </thead>
                    <tbody id="projectionsTableBody">
                        {% for player, line in projections.items() %}
                        <tr>
                            <td>{{ player }}</td>
                            <td>{{ line }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>THE ORACLE | NBA API | Real-time edge detection</p>
        </footer>
    </div>

    <script>
        let autoRefreshInterval = null;
        const REFRESH_INTERVAL = 60000; // 60 seconds

        function updatePage(data) {
            // Update timestamp
            document.getElementById('lastUpdate').textContent = `Last updated: ${data.timestamp}`;
            
            // Clear error
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = '';
            
            if (data.error) {
                errorContainer.innerHTML = `<div class="error-message"><strong>Error:</strong> ${data.error}</div>`;
                return;
            }

            // Update player count
            const totalPlayersEl = document.getElementById('totalPlayers');
            const filteredCountEl = document.getElementById('filteredCount');
            if (totalPlayersEl) totalPlayersEl.textContent = data.total_players_loaded || 0;
            if (filteredCountEl) filteredCountEl.textContent = data.edges?.length || 0;
            
            // Update edges
            const edgesContainer = document.getElementById('edgesContainer');
            const edges = data.edges || [];
            const showing70Plus = data.showing_70_plus_only !== false;
            
            if (edges.length > 0) {
                edgesContainer.innerHTML = `
                    <div class="edges-section">
                        <h2>${showing70Plus ? '70%+ PROBABILITY PROPS' : 'ALL EDGES'} (<span id="edgeCount">${edges.length}</span>)</h2>
                        ${showing70Plus ? '<p class="section-subtitle">Only showing props with 70%+ hit probability from all active NBA players</p>' : '<p class="section-subtitle">Showing all edges (including below 70%)</p>'}
                        <div class="edges-grid" id="edgesGrid">
                            ${edges.map(edge => {
                                const streakBadge = edge.streak && edge.streak.active 
                                    ? `<div class="streak-badge streak-${edge.streak.streak_type.toLowerCase()}">üî• ${edge.streak.streak_count}-game ${edge.streak.streak_type} streak</div>`
                                    : '';
                                
                                if (edge.oracle) {
                                    const confidenceClass = Math.floor(edge.oracle.confidence);
                                    const advancedMetrics = edge.advanced_metrics 
                                        ? `<div class="advanced-metrics"><div class="metrics-row"><span>FG%:</span> <span>${edge.advanced_metrics.fg_pct}%</span> <span>Pts/36:</span> <span>${edge.advanced_metrics.points_per_36}</span> <span>CV:</span> <span>${edge.advanced_metrics.consistency}%</span></div></div>`
                                        : '';
                                    
                                    return `
                                    <div class="oracle-card ${edge.recommendation.toLowerCase()}">
                                        <div class="oracle-header-row">
                                            <div class="oracle-player">${edge.player}</div>
                                            ${edge.ev ? `
                                            <div class="ev-badge ${edge.ev.is_positive_ev ? 'positive-ev' : 'negative-ev'}">
                                                EV: $${edge.ev.ev.toFixed(2)}
                                            </div>
                                            ` : ''}
                                            ${edge.matchup_grade ? `
                                            <div class="grade-badge grade-${edge.matchup_grade.grade.toLowerCase().replace('+', 'plus').replace('-', 'minus')}">
                                                ${edge.matchup_grade.grade}
                                            </div>
                                            ` : ''}
                                        </div>
                                        <div class="oracle-content">
                                            <div class="oracle-line"><strong>The Line:</strong> ${edge.oracle.verdict}</div>
                                            <div class="oracle-sharp"><strong>The Sharp Angle:</strong> ${edge.oracle.sharp_angle}</div>
                                            <div class="oracle-key"><strong>Key Data Point:</strong> ${edge.oracle.key_data}</div>
                                            <div class="oracle-verdict"><strong>The Verdict:</strong> ${edge.oracle.verdict}</div>
                                            <div class="oracle-confidence"><strong>Confidence:</strong> <span class="confidence-badge confidence-${confidenceClass}">${edge.oracle.confidence} Units</span></div>
                                            <div class="oracle-risk"><strong>Risk Factor:</strong> ${edge.oracle.risk_factor}</div>
                                        ${advancedMetrics}
                                    </div>
                                    ${edge.beneficiary ? `
                                    <div class="phase2-analysis">
                                        <div class="phase2-header" onclick="togglePhase2(this)">
                                            <span>‚ö° PHASE 2: STATISTICAL BENEFICIARY</span>
                                            <span class="toggle-icon">‚ñº</span>
                                        </div>
                                        <div class="phase2-content" style="display: none;">
                                            <div class="phase2-item"><strong>1. The Player:</strong> ${edge.beneficiary.player} (${edge.beneficiary.position})</div>
                                            <div class="phase2-item"><strong>2. The Mismatch:</strong> ${edge.beneficiary.mismatch}</div>
                                            <div class="phase2-item"><strong>3. The Consensus Expectation:</strong> ${edge.beneficiary.consensus_expectation} ${edge.stat_type}</div>
                                            <div class="phase2-item"><strong>4. The Projection:</strong> ${edge.beneficiary.projection_direction} (${edge.beneficiary.projection} ${edge.stat_type})</div>
                                            <div class="phase2-item"><strong>5. The Confidence Logic:</strong> ${edge.beneficiary.confidence_logic}</div>
                                            ${edge.beneficiary.matchup_data ? `
                                            <div class="phase2-metrics">
                                                <div class="metric-item"><span>Avg vs Opponent:</span> <span>${edge.beneficiary.matchup_data.avg_vs_opponent}</span></div>
                                                <div class="metric-item"><span>Overall Avg:</span> <span>${edge.beneficiary.matchup_data.overall_avg}</span></div>
                                                ${edge.beneficiary.matchup_data.advantage ? `<div class="metric-item"><span>Advantage:</span> <span class="advantage-positive">+${edge.beneficiary.matchup_data.advantage}</span></div>` : ''}
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ` : ''}
                                    ${streakBadge}
                                    </div>
                                    `;
                                } else {
                                    return `
                                    <div class="edge-card ${edge.recommendation.toLowerCase()}">
                                        <div class="player-name">${edge.player}</div>
                                        <div class="edge-details">
                                            <div class="stat-row"><span class="label">Line:</span><span class="value">${edge.line}</span></div>
                                            <div class="stat-row"><span class="label">L5 Avg:</span><span class="value">${edge.average}</span></div>
                                            <div class="recommendation"><strong>${edge.recommendation}</strong></div>
                                        </div>
                                        ${streakBadge}
                                    </div>
                                    `;
                                }
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                const playerCount = Object.keys(data.projections).length;
                edgesContainer.innerHTML = `
                    <div class="no-edges">
                        <p>No edges found with current threshold.</p>
                        <p class="info">Checked <span id="playerCount">${playerCount}</span> players. Adjust threshold or check projections.</p>
                    </div>
                `;
            }

            // Update streaks (sort by streak count, longest first)
            const streaksContainer = document.getElementById('streaksContainer');
            let streaks = data.streaks || [];
            streaks.sort((a, b) => (b.streak_count || 0) - (a.streak_count || 0));
            
            if (streaks.length > 0) {
                streaksContainer.innerHTML = `
                    <div class="streaks-section">
                        <h2>üî• Active Streaks (<span id="streakCount">${streaks.length}</span>)</h2>
                        <p class="section-subtitle">Players consistently hitting OVER/UNDER for 2+ games</p>
                        <div class="streaks-grid" id="streaksGrid">
                            ${streaks.map(streak => `
                                <div class="streak-card streak-${streak.streak_type.toLowerCase()}">
                                    <div class="player-name">${streak.player}</div>
                                    <div class="streak-details">
                                        <div class="stat-row">
                                            <span class="label">Line:</span>
                                            <span class="value">${streak.line}</span>
                                        </div>
                                        ${streak.average ? `
                                        <div class="stat-row">
                                            <span class="label">L5 Average:</span>
                                            <span class="value">${streak.average}</span>
                                        </div>
                                        ` : ''}
                                        <div class="streak-info">
                                            <div class="streak-badge-large streak-${streak.streak_type.toLowerCase()}">
                                                üî• ${streak.streak_count}-game ${streak.streak_type} streak
                                            </div>
                                        </div>
                                        ${streak.factors ? `
                                        <div class="performance-factors">
                                            <div class="factors-header" onclick="toggleFactors(this)">
                                                <span>üìä Performance Factors</span>
                                                <span class="toggle-icon">‚ñº</span>
                                            </div>
                                            <div class="factors-content" style="display: none;">
                                                ${edge.factors.injury_risk ? `
                                                <div class="factor-badge factor-warning">
                                                    ‚ö†Ô∏è Injury Risk (${edge.factors.dnp_count} DNP game${edge.factors.dnp_count !== 1 ? 's' : ''})
                                                </div>
                                                ` : ''}
                                                ${edge.factors.rotation_change ? `
                                                <div class="factor-badge factor-info">
                                                    üîÑ Rotation Change (${edge.factors.recent_minutes_avg} min recent vs ${edge.factors.older_minutes_avg} min earlier)
                                                </div>
                                                ` : ''}
                                                <div class="factor-row">
                                                    <span class="factor-label">Minutes Trend:</span>
                                                    <span class="factor-value trend-${edge.factors.minutes_trend}">
                                                        ${edge.factors.recent_minutes_avg} min (${edge.factors.minutes_trend})
                                                    </span>
                                                </div>
                                                <div class="factor-row">
                                                    <span class="factor-label">Performance Trend:</span>
                                                    <span class="factor-value trend-${edge.factors.performance_trend}">
                                                        ${edge.factors.performance_trend.charAt(0).toUpperCase() + edge.factors.performance_trend.slice(1)}
                                                    </span>
                                                </div>
                                                ${edge.factors.shooting_efficiency ? `
                                                <div class="factor-row">
                                                    <span class="factor-label">FG% (L5):</span>
                                                    <span class="factor-value">${edge.factors.shooting_efficiency}%</span>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                const playerCount = Object.keys(data.projections).length;
                edgesContainer.innerHTML = `
                    <div class="no-edges">
                        <p>No edges found with current threshold.</p>
                        <p class="info">Checked <span id="playerCount">${playerCount}</span> players. Adjust threshold or check projections.</p>
                    </div>
                `;
            }

            // Update streaks (sort by streak count, longest first)
            const streaksContainer = document.getElementById('streaksContainer');
            let streaks = data.streaks || [];
            streaks.sort((a, b) => (b.streak_count || 0) - (a.streak_count || 0));
            
            if (streaks.length > 0) {
                streaksContainer.innerHTML = `
                    <div class="streaks-section">
                        <h2>üî• Active Streaks (<span id="streakCount">${streaks.length}</span>)</h2>
                        <p class="section-subtitle">Players consistently hitting OVER/UNDER for 2+ games</p>
                        <div class="streaks-grid" id="streaksGrid">
                            ${streaks.map(streak => `
                                <div class="streak-card streak-${streak.streak_type.toLowerCase()}">
                                    <div class="player-name">${streak.player}</div>
                                    <div class="streak-details">
                                        <div class="stat-row">
                                            <span class="label">Line:</span>
                                            <span class="value">${streak.line}</span>
                                        </div>
                                        ${streak.average ? `
                                        <div class="stat-row">
                                            <span class="label">L5 Average:</span>
                                            <span class="value">${streak.average}</span>
                                        </div>
                                        ` : ''}
                                        <div class="streak-info">
                                            <div class="streak-badge-large streak-${streak.streak_type.toLowerCase()}">
                                                üî• ${streak.streak_count}-game ${streak.streak_type} streak
                                            </div>
                                        </div>
                                        ${streak.factors ? `
                                        <div class="performance-factors">
                                            <div class="factors-header" onclick="toggleFactors(this)">
                                                <span>üìä Performance Factors</span>
                                                <span class="toggle-icon">‚ñº</span>
                                            </div>
                                            <div class="factors-content" style="display: none;">
                                                ${streak.factors.injury_risk ? `
                                                <div class="factor-badge factor-warning">
                                                    ‚ö†Ô∏è Injury Risk (${streak.factors.dnp_count} DNP game${streak.factors.dnp_count !== 1 ? 's' : ''})
                                                </div>
                                                ` : ''}
                                                ${streak.factors.rotation_change ? `
                                                <div class="factor-badge factor-info">
                                                    üîÑ Rotation Change (${streak.factors.recent_minutes_avg} min recent vs ${streak.factors.older_minutes_avg} min earlier)
                                                </div>
                                                ` : ''}
                                                <div class="factor-row">
                                                    <span class="factor-label">Minutes Trend:</span>
                                                    <span class="factor-value trend-${streak.factors.minutes_trend}">
                                                        ${streak.factors.recent_minutes_avg} min (${streak.factors.minutes_trend})
                                                    </span>
                                                </div>
                                                <div class="factor-row">
                                                    <span class="factor-label">Performance Trend:</span>
                                                    <span class="factor-value trend-${streak.factors.performance_trend}">
                                                        ${streak.factors.performance_trend.charAt(0).toUpperCase() + streak.factors.performance_trend.slice(1)}
                                                    </span>
                                                </div>
                                                ${streak.factors.shooting_efficiency ? `
                                                <div class="factor-row">
                                                    <span class="factor-label">FG% (L5):</span>
                                                    <span class="factor-value">${streak.factors.shooting_efficiency}%</span>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                streaksContainer.innerHTML = '';
            }

            // Update parlay recommendations
            checkParlayRecommendations(data);
            
            // Update high probability props
            const highProbContainer = document.getElementById('highProbContainer');
            const highProbProps = data.high_prob_props || [];
            
            if (highProbProps.length > 0) {
                highProbContainer.innerHTML = `
                    <div class="high-prob-section">
                        <h2>üéØ HIGH PROBABILITY PROPS (70%+) - <span id="highProbCount">${highProbProps.length}</span></h2>
                        <p class="section-subtitle">PrizePicks/Underdog Format | Sorted by Probability</p>
                        <div class="high-prob-grid" id="highProbGrid">
                            ${highProbProps.map(prop => {
                                const streakBadge = prop.edge.streak && prop.edge.streak.active 
                                    ? `<div class="streak-indicator">üî• ${prop.edge.streak.streak_count}-game ${prop.edge.streak.streak_type} streak</div>`
                                    : '';
                                const matchupBadge = prop.beneficiary 
                                    ? `<div class="matchup-indicator">‚ö° vs ${prop.beneficiary.opponent}: ${prop.beneficiary.mismatch}</div>`
                                    : '';
                                
                                return `
                                <div class="high-prob-card">
                                    <div class="prob-header">
                                        <div class="prob-badge">${prop.probability}%</div>
                                        <div class="prizepicks-display">${prop.prizepicks.display}</div>
                                    </div>
                                    <div class="prob-details">
                                        <div class="prob-reasoning">
                                            <strong>Reasoning:</strong> ${prop.reasoning}
                                        </div>
                                        <div class="prob-stats">
                                            <div class="stat-item">
                                                <span>L5 Average:</span>
                                                <span>${prop.edge.average}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span>Line:</span>
                                                <span>${prop.edge.line}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span>Edge:</span>
                                                <span class="edge-value">${prop.edge.difference}pts</span>
                                            </div>
                                        </div>
                                        ${streakBadge}
                                        ${matchupBadge}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                highProbContainer.innerHTML = '';
            }

            // Update projections table
            const projectionsTable = document.getElementById('projectionsTable');
            const tbody = document.getElementById('projectionsTableBody');
            const projectionCount = document.getElementById('projectionCount');
            
            tbody.innerHTML = Object.entries(data.projections).map(([player, line]) => `
                <tr>
                    <td>${player}</td>
                    <td>${line}</td>
                </tr>
            `).join('');
            
            projectionCount.textContent = Object.keys(data.projections).length;
        }

        function filterPlayers() {
            const searchInput = document.getElementById('playerSearch');
            const filter = searchInput.value.toLowerCase();
            const table = document.getElementById('projectionsTable');
            const rows = table.getElementsByTagName('tr');
            
            let visibleCount = 0;
            
            // Start from index 1 to skip header row
            for (let i = 1; i < rows.length; i++) {
                const playerCell = rows[i].getElementsByTagName('td')[0];
                if (playerCell) {
                    const playerName = playerCell.textContent || playerCell.innerText;
                    if (playerName.toLowerCase().indexOf(filter) > -1) {
                        rows[i].style.display = '';
                        visibleCount++;
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }

        let refreshTimeout = null;
        let isRefreshing = false;
        
        async function refreshData() {
            // Debounce: prevent multiple simultaneous refreshes
            if (isRefreshing) {
                console.log('Refresh already in progress, skipping...');
                return;
            }
            
            isRefreshing = true;
            const refreshBtn = document.getElementById('refreshBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const showAllToggle = document.getElementById('showAllToggle');
            const showAll = showAllToggle ? showAllToggle.checked : false;
            
            refreshBtn.disabled = true;
            loadingIndicator.style.display = 'inline';
            
            try {
                const filterParams = buildFilterParams();
                const url = '/api/edges' + (filterParams ? '?' + filterParams : '');
                const response = await fetch(url);
                const data = await response.json();
                updatePage(data);
            } catch (error) {
                document.getElementById('errorContainer').innerHTML = 
                    `<div class="error-message"><strong>Error:</strong> Failed to fetch data: ${error.message}</div>`;
            } finally {
                refreshBtn.disabled = false;
                loadingIndicator.style.display = 'none';
                isRefreshing = false;  // Reset flag
            }
        }

        function toggleShowAll() {
            refreshData();
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            if (checkbox.checked) {
                // Start auto-refresh
                autoRefreshInterval = setInterval(refreshData, REFRESH_INTERVAL);
                console.log('Auto-refresh enabled');
            } else {
                // Stop auto-refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                console.log('Auto-refresh disabled');
            }
        }

        async function loadAllActivePlayers() {
            const loadBtn = document.getElementById('loadPlayersBtn');
            const progressDiv = document.getElementById('loadProgress');
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            if (!confirm('This will load ALL active NBA players and may take 10-15 minutes due to API rate limits. Continue?')) {
                return;
            }
            
            loadBtn.disabled = true;
            progressDiv.style.display = 'block';
            progressText.textContent = 'Starting to load all active players...';
            progressFill.style.width = '0%';
            
            try {
                const response = await fetch('/api/load-all-players', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        season: '2023-24',
                        stat_type: 'PTS'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    progressFill.style.width = '100%';
                    progressText.textContent = `Successfully loaded ${data.count} players!`;
                    
                    // Refresh the page data after a short delay
                    setTimeout(() => {
                        refreshData();
                        progressDiv.style.display = 'none';
                        alert(`Successfully loaded ${data.count} active NBA players!`);
                    }, 2000);
                } else {
                    progressText.textContent = `Error: ${data.error}`;
                    alert(`Error loading players: ${data.error}`);
                }
            } catch (error) {
                progressText.textContent = `Error: ${error.message}`;
                alert(`Failed to load players: ${error.message}`);
            } finally {
                loadBtn.disabled = false;
            }
        }

        function toggleFactors(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function togglePhase2(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        // Line Management Functions
        function showLineManagement() {
            document.getElementById('lineManagementPanel').style.display = 'block';
            loadLineChanges();
            loadChaseList();
            loadAltLines();
            loadDailyUpdateStatus();
        }

        function hideLineManagement() {
            document.getElementById('lineManagementPanel').style.display = 'none';
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadLineChanges() {
            try {
                const response = await fetch('/api/line-changes');
                const data = await response.json();
                const container = document.getElementById('lineChangesContainer');
                
                if (data.changes && Object.keys(data.changes).length > 0) {
                    container.innerHTML = Object.entries(data.changes).map(([player, change]) => `
                        <div class="line-change-card">
                            <div class="change-player">${player}</div>
                            <div class="change-details">
                                <span class="old-line">${change.previous}</span>
                                <span class="arrow">‚Üí</span>
                                <span class="new-line">${change.current}</span>
                                <span class="movement ${change.direction}">${change.movement > 0 ? '+' : ''}${change.movement}</span>
                            </div>
                            <div class="change-direction">Line moved ${change.direction}</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="no-data">No line changes detected in last 24h</p>';
                }
            } catch (error) {
                console.error('Error loading line changes:', error);
            }
        }

        async function loadChaseList() {
            try {
                const response = await fetch('/api/chase-list');
                const data = await response.json();
                const container = document.getElementById('chaseListContainer');
                
                if (data.chase_list && data.chase_list.length > 0) {
                    container.innerHTML = data.chase_list.map(item => `
                        <div class="chase-item">
                            <div class="chase-player">${item.player}</div>
                            <div class="chase-line">Line: ${item.line} ${item.stat_type}</div>
                            <div class="chase-reason">${item.reason || 'No reason provided'}</div>
                            <button onclick="removeFromChase('${item.player}', '${item.stat_type}')" class="remove-btn">Remove</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="no-data">No props in chase list</p>';
                }
            } catch (error) {
                console.error('Error loading chase list:', error);
            }
        }

        async function loadAltLines() {
            try {
                const response = await fetch('/api/alt-lines');
                const data = await response.json();
                const container = document.getElementById('altLinesContainer');
                
                if (data.alt_lines && Object.keys(data.alt_lines).length > 0) {
                    container.innerHTML = Object.entries(data.alt_lines).map(([player, lines]) => `
                        <div class="alt-line-card">
                            <div class="alt-player">${player}</div>
                            ${lines.map(line => `
                                <div class="alt-line-item">
                                    <span>Main: ${line.main_line}</span>
                                    <span>Alt: ${line.alt_line}</span>
                                    <span class="diff">Diff: ${line.difference > 0 ? '+' : ''}${line.difference}</span>
                                    <span class="source">${line.source || 'Unknown'}</span>
                                </div>
                            `).join('')}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="no-data">No alternative lines tracked</p>';
                }
            } catch (error) {
                console.error('Error loading alt lines:', error);
            }
        }

        async function updateLine() {
            const player = document.getElementById('editPlayerSelect').value;
            const oldLine = parseFloat(document.getElementById('oldLineInput').value);
            const newLine = parseFloat(document.getElementById('newLineInput').value);
            
            if (!player || isNaN(oldLine) || isNaN(newLine)) {
                alert('Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch('/api/update-line', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        player: player,
                        old_line: oldLine,
                        new_line: newLine,
                        stat_type: 'PTS'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('editResult').innerHTML = 
                        `<div class="success-msg">‚úÖ ${data.message}</div>`;
                    // Clear inputs
                    document.getElementById('oldLineInput').value = '';
                    document.getElementById('newLineInput').value = '';
                    // Refresh data
                    refreshData();
                } else {
                    document.getElementById('editResult').innerHTML = 
                        `<div class="error-msg">‚ùå ${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('editResult').innerHTML = 
                    `<div class="error-msg">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function removeFromChase(player, statType) {
            try {
                const response = await fetch('/api/chase-list', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({player: player, stat_type: statType})
                });
                
                if (response.ok) {
                    loadChaseList();
                }
            } catch (error) {
                console.error('Error removing from chase list:', error);
            }
        }

        async function loadDailyUpdateStatus() {
            try {
                const response = await fetch('/api/daily-update-status');
                const data = await response.json();
                const statusEl = document.getElementById('dailyUpdateStatus');
                
                if (data.daily_update_scheduled && data.next_run) {
                    const nextRun = new Date(data.next_run);
                    const now = new Date();
                    const hoursUntil = Math.floor((nextRun - now) / (1000 * 60 * 60));
                    const minsUntil = Math.floor(((nextRun - now) % (1000 * 60 * 60)) / (1000 * 60));
                    
                    statusEl.textContent = `‚è∞ Next update: ${hoursUntil}h ${minsUntil}m`;
                    statusEl.style.color = '#ffd700';
                } else {
                    statusEl.textContent = '‚è∞ Daily update: Not scheduled';
                    statusEl.style.color = '#888';
                }
            } catch (error) {
                console.error('Error loading update status:', error);
            }
        }

        // Initial load timestamp
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date().toLocaleString();
            document.getElementById('lastUpdate').textContent = `Last updated: ${now}`;
            loadDailyUpdateStatus();
            // Refresh status every minute
            setInterval(loadDailyUpdateStatus, 60000);
        });
    </script>
    <script src="{{ url_for('static', filename='parlay_ui.js') }}"></script>
</body>
</html>
